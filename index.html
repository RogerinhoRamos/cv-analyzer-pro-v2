<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📊 Analisador de Currículos - Sistema Completo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configurar PDF.js worker para evitar warnings
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.2em;
        }
        
        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: 150px;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            transform: translateY(-2px);
        }
        
        .tab:hover:not(.active) {
            background: rgba(52, 152, 219, 0.1);
        }
        
        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Upload Area */
        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            background: rgba(52, 152, 219, 0.05);
            border-color: #2980b9;
        }
        
        .upload-area.dragover {
            background: rgba(52, 152, 219, 0.1);
            border-color: #2980b9;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        .upload-text {
            font-size: 1.2em;
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        
        .file-input {
            display: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn.secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }
        
        .btn.success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }
        
        .btn.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn:disabled:hover {
            transform: none !important;
            box-shadow: none !important;
        }
        
        /* Configuração de Vaga */
        .vaga-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }
        
        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .endereco-validado {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 4px solid #28a745;
        }
        
        /* Templates */
        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .template-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 25px;
            border-left: 5px solid #3498db;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .template-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .template-card.selected {
            border-left-color: #2ecc71;
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
        }
        
        .template-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .template-description {
            color: #7f8c8d;
            margin-bottom: 15px;
        }
        
        .template-criterios {
            font-size: 0.9em;
            color: #6c757d;
        }
        
        /* Editor de Template */
        .template-editor {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .criterio-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #3498db;
        }
        
        .criterio-nome {
            font-weight: bold;
            flex: 1;
        }
        
        .criterio-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .peso-slider {
            width: 100px;
        }
        
        .peso-value {
            min-width: 30px;
            font-weight: bold;
            color: #3498db;
        }
        
        .obrigatorio-checkbox {
            transform: scale(1.2);
        }
        
        /* Progress Bar */
        .progress-container {
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-bar {
            height: 20px;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        /* Estatísticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 1em;
        }
        
        /* Rankings */
        .ranking-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .ranking-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .ranking-title {
            color: #2c3e50;
            font-size: 1.6em;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        
        .candidato-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: linear-gradient(90deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
        }
        
        .candidato-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .candidato-info {
            flex: 1;
        }
        
        .candidato-nome {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        .candidato-detalhes {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 3px;
        }
        
        .candidato-endereco {
            color: #6c757d;
            font-size: 0.8em;
        }
        
        .candidato-competencias {
            color: #2980b9;
            font-size: 0.8em;
            font-weight: 500;
            margin-top: 5px;
            line-height: 1.3;
        }
        
        .candidato-scores {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .score-total {
            background: #3498db;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .score-detalhes {
            font-size: 0.8em;
            color: #7f8c8d;
        }
        
        /* Gráficos */
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .chart-title {
            color: #2c3e50;
            font-size: 1.4em;
            margin-bottom: 20px;
            text-align: center;
        }
        
        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Seleção de Candidatos */
        .candidato-selecionavel {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .candidato-selecionavel:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .candidato-incluido {
            background: #f8fff8;
            border-color: #2ecc71;
        }
        
        .candidato-excluido {
            background: #fff5f5;
            border-color: #e74c3c;
        }
        
        /* Alertas */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid;
        }
        
        .alert.success {
            background: #d4edda;
            color: #155724;
            border-left-color: #28a745;
        }
        
        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }
        
        .alert.warning {
            background: #fff3cd;
            color: #856404;
            border-left-color: #ffc107;
        }
        
        .alert.info {
            background: #d1ecf1;
            color: #0c5460;
            border-left-color: #17a2b8;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .vaga-config {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                min-width: auto;
            }
            
            .candidato-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .candidato-scores {
                align-self: flex-end;
                flex-direction: row;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 Analisador de Currículos</h1>
            <p>Sistema Inteligente de Análise e Seleção de Candidatos</p>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('upload')">📄 Upload PDF</div>
            <div class="tab" onclick="showTab('config')">⚙️ Configuração</div>
            <div class="tab" onclick="showTab('selecao')">👥 Seleção</div>
            <div class="tab" onclick="showTab('templates')">📋 Templates</div>
            <div class="tab" onclick="showTab('analise')">🔍 Análise</div>
            <div class="tab" onclick="showTab('dashboard')">📊 Dashboard</div>
        </div>

        <!-- ABA 1: Upload PDF -->
        <div class="tab-content active" id="upload">
            <h2>📄 Upload do PDF com Currículos</h2>
            
            <div class="upload-area" onclick="document.getElementById('pdfFile').click()">
                <div class="upload-icon">📄</div>
                <div class="upload-text">
                    Clique aqui ou arraste o arquivo PDF com os currículos
                </div>
                <button class="btn">📎 Selecionar Arquivo PDF</button>
            </div>
            
            <input type="file" id="pdfFile" class="file-input" accept=".pdf">
            
            <!-- Botão de teste/debug -->
            <div style="text-align: center; margin: 15px 0;">
                <button class="btn secondary" onclick="testarUpload()" style="font-size: 0.9em;">
                    🔧 Testar Sistema de Upload
                </button>
            </div>
            
            <div id="fileInfo" class="hidden">
                <div class="alert info">
                    <strong>📁 Arquivo carregado:</strong> <span id="fileName"></span>
                </div>
            </div>
            
            <div class="loading" id="loadingPDF">
                <div class="spinner"></div>
                <p>Processando PDF... Extraindo lista de candidatos...</p>
            </div>
            
            <div id="candidatesList" class="hidden">
                <h3>👥 Candidatos Encontrados</h3>
                <div id="candidatesCount" class="alert success"></div>
                <div id="candidatesPreview"></div>
                <button class="btn success" onclick="showTab('config')">➡️ Próximo: Configurar Vaga</button>
            </div>
        </div>

        <!-- ABA 2: Configuração da Vaga -->
        <div class="tab-content" id="config">
            <h2>🎯 Configuração da Vaga</h2>
            
            <div class="vaga-config">
                <div>
                    <div class="input-group">
                        <label>🏢 Cargo/Posição</label>
                        <input type="text" id="cargoVaga" placeholder="Ex: Preparador/Operador CNC Multifuncional">
                    </div>
                    
                    <div class="input-group">
                        <label>🏭 Empresa</label>
                        <input type="text" id="empresaVaga" placeholder="Ex: KSB do Brasil Ltda">
                    </div>
                    
                    <div class="input-group">
                        <label>📍 Localização da Vaga</label>
                        <input type="text" id="enderecoVaga" placeholder="Ex: KSB do Brasil - Av. Alberto Vollet Sachs, 400 - Jundiaí, SP">
                        <button class="btn secondary" style="margin-top: 10px;" onclick="validarEndereco()">📌 Validar Endereço</button>
                    </div>

                    <div class="input-group">
                        <label>🗺️ Raio de Abrangência (km)</label>
                        <select id="raioAbrangencia">
                            <option value="15">15 km (Região próxima)</option>
                            <option value="25" selected>25 km (Região metropolitana)</option>
                            <option value="35">35 km (Região estendida)</option>
                            <option value="50">50 km (Região ampla)</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <div class="input-group">
                        <label>⏰ Turno</label>
                        <select id="turnoVaga">
                            <option value="">Selecione o turno</option>
                            <option value="manha">Manhã</option>
                            <option value="tarde">Tarde</option>
                            <option value="noite">Noite</option>
                            <option value="administrativo">Administrativo</option>
                            <option value="revezamento">Revezamento</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label>💰 Faixa Salarial (Opcional)</label>
                        <input type="text" id="salarioVaga" placeholder="Ex: R$ 4.200 - R$ 5.800">
                    </div>
                    
                    <div class="input-group">
                        <label>📝 Observações</label>
                        <textarea id="observacoesVaga" rows="3" placeholder="Ex: Experiência com comandos Fanuc/Siemens obrigatória. VT + VR + Plano de Saúde"></textarea>
                    </div>
                </div>
            </div>
            
            <div id="enderecoValidado" class="hidden endereco-validado">
                ✅ <strong>Endereço validado:</strong> <span id="enderecoNormalizado"></span>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn success" onclick="showTab('selecao')">➡️ Próximo: Selecionar Candidatos</button>
            </div>
        </div>

        <!-- ABA 3: Seleção de Candidatos -->
        <div class="tab-content" id="selecao">
            <h2>👥 Seleção de Candidatos</h2>
            
            <!-- Resumo -->
            <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #3498db;">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">📊 Resumo</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <span style="font-size: 1.8em; color: #3498db; font-weight: bold;" id="totalCandidatos">0</span>
                        <div style="color: #7f8c8d;">candidatos encontrados</div>
                    </div>
                    <div>
                        <span style="font-size: 1.8em; color: #2ecc71; font-weight: bold;" id="candidatosSelecionados">0</span>
                        <div style="color: #7f8c8d;">selecionados para análise</div>
                    </div>
                    <div>
                        <span style="font-size: 1.8em; color: #e74c3c; font-weight: bold;" id="candidatosExcluidos">0</span>
                        <div style="color: #7f8c8d;">excluídos</div>
                    </div>
                </div>
            </div>
            
            <!-- Ferramentas -->
            <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">🔧 Ferramentas de Seleção</h3>
                
                <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                    <button class="btn" onclick="selecionarTodos()">☑️ Selecionar Todos</button>
                    <button class="btn secondary" onclick="desmarcarTodos()">☐ Desmarcar Todos</button>
                    <button class="btn secondary" onclick="inverterSelecao()">🔄 Inverter Seleção</button>
                </div>
                
                <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                    <div>
                        <label style="margin-right: 10px;">📍 Filtrar por distância:</label>
                        <select id="filtroDistancia" onchange="aplicarFiltros()">
                            <option value="todos">Todos os candidatos</option>
                            <option value="15">≤ 15km (Muito perto)</option>
                            <option value="25">≤ 25km (Perto)</option>
                            <option value="50">≤ 50km (Raio amplo)</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="margin-right: 10px;">🔍 Buscar candidato:</label>
                        <input type="text" id="buscaCandidato" placeholder="Digite o nome..." 
                               style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 200px;"
                               oninput="aplicarFiltros()">
                    </div>
                </div>
            </div>
            
            <!-- Lista de Candidatos -->
            <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">📋 Lista de Candidatos</h3>
                
                <div id="listaCandidatos" style="max-height: 400px; overflow-y: auto;">
                    <!-- Lista será preenchida dinamicamente -->
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn secondary" onclick="showTab('config')">⬅️ Voltar: Configuração</button>
                <button class="btn success" style="margin-left: 10px;" onclick="showTab('templates')">➡️ Próximo: Selecionar Template</button>
            </div>
        </div>

        <!-- ABA 4: Templates -->
        <div class="tab-content" id="templates">
            <h2>📋 Selecionar Template de Avaliação</h2>
            
            <div class="templates-grid" id="templatesGrid">
                <!-- Templates serão carregados dinamicamente -->
            </div>
            
            <div class="template-editor hidden" id="templateEditor">
                <h3>⚙️ Personalizar Critérios</h3>
                <div id="criteriosEditor">
                    <!-- Critérios serão carregados dinamicamente -->
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn secondary" onclick="resetTemplate()">🔄 Resetar</button>
                    <button class="btn success" onclick="salvarTemplate()">💾 Salvar Template</button>
                </div>
            </div>
            
            <!-- Status das etapas -->
            <div id="statusEtapas" style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-top: 20px;">
                <h4 style="color: #2c3e50; margin-bottom: 15px;">📋 Status das Etapas</h4>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div id="status-candidatos" style="padding: 8px; border-radius: 5px; background: #f8d7da; color: #721c24;">
                        ❌ Candidatos não carregados
                    </div>
                    <div id="status-selecao" style="padding: 8px; border-radius: 5px; background: #f8d7da; color: #721c24;">
                        ❌ Seleção não definida
                    </div>
                    <div id="status-template" style="padding: 8px; border-radius: 5px; background: #f8d7da; color: #721c24;">
                        ❌ Template não selecionado
                    </div>
                    <div id="status-endereco" style="padding: 8px; border-radius: 5px; background: #f8d7da; color: #721c24;">
                        ❌ Endereço não validado
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn success" onclick="iniciarAnalise()">🚀 Iniciar Análise</button>
                <button class="btn secondary" style="margin-left: 10px;" onclick="debugAnalise()">🔍 Debug</button>
            </div>
        </div>

        <!-- ABA 5: Análise -->
        <div class="tab-content" id="analise">
            <h2>🔍 Análise em Andamento</h2>
            
            <div class="progress-container">
                <div class="progress-bar" id="progressBar" style="width: 0%;">0%</div>
            </div>
            
            <div class="loading show" id="loadingAnalise">
                <div class="spinner"></div>
                <p id="analiseStatus">Iniciando análise...</p>
            </div>
            
            <div id="analiseCompleta" class="hidden">
                <div class="alert success">
                    <strong>✅ Análise Concluída!</strong> Todos os candidatos foram processados com sucesso.
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn success" onclick="showTab('dashboard')">📊 Ver Dashboard</button>
                </div>
            </div>
        </div>

        <!-- ABA 6: Dashboard -->
        <div class="tab-content" id="dashboard">
            <h2>📊 Dashboard de Resultados</h2>
            
            <div class="stats-grid" id="statsGrid">
                <!-- Estatísticas serão carregadas dinamicamente -->
            </div>
            
            <div class="charts-section" id="chartsSection">
                <!-- Gráficos serão carregados dinamicamente -->
            </div>
            
            <div class="ranking-container" id="rankingContainer">
                <!-- Rankings serão carregados dinamicamente -->
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="exportarRelatorio()">📄 Exportar Relatório PDF</button>
                <button class="btn secondary" onclick="novaAnalise()">🔄 Nova Análise</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div style="text-align: center; padding: 30px 20px;">
        <div style="
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 16px 35px;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.4);
            margin: 0 auto;
            max-width: 1400px;
        ">
            <div style="
                display: flex;
                flex-direction: column;
                gap: 10px;
            ">
                <div style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 12px;
                    flex-wrap: wrap;
                ">
                    <div style="
                        font-size: 1.2em;
                        color: #2c3e50;
                        font-weight: bold;
                    ">📊 CV Analyzer Pro</div>
                    
                    <span style="
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        padding: 6px 12px;
                        background: linear-gradient(135deg, #3498db, #2980b9);
                        border-radius: 15px;
                        color: white;
                        font-weight: 600;
                        font-size: 0.75em;
                        box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
                    ">🔖 BETA v1.0</span>
                </div>
                
                <div style="
                    font-size: 1em;
                    color: #34495e;
                    font-weight: 500;
                ">© 2025 Desenvolvido por <strong style="color: #2c3e50;">Rogerinho Ramos</strong></div>
                
                <div style="
                    display: flex;
                    gap: 12px;
                    justify-content: center;
                    font-size: 0.85em;
                    font-weight: 500;
                    flex-wrap: wrap;
                    align-items: center;
                    margin-top: 2px;
                ">
                    <span style="
                        display: flex;
                        align-items: center;
                        gap: 5px;
                        padding: 5px 10px;
                        background: rgba(52, 73, 94, 0.1);
                        border-radius: 12px;
                        color: #34495e;
                        font-weight: 500;
                    ">⚡ HTML5</span>
                    
                    <span style="
                        display: flex;
                        align-items: center;
                        gap: 5px;
                        padding: 5px 10px;
                        background: rgba(52, 73, 94, 0.1);
                        border-radius: 12px;
                        color: #34495e;
                        font-weight: 500;
                    ">📊 Chart.js</span>
                    
                    <span style="
                        display: flex;
                        align-items: center;
                        gap: 5px;
                        padding: 5px 10px;
                        background: rgba(52, 73, 94, 0.1);
                        border-radius: 12px;
                        color: #34495e;
                        font-weight: 500;
                    ">📄 PDF.js</span>
                    
                    <span style="
                        display: flex;
                        align-items: center;
                        gap: 5px;
                        padding: 5px 10px;
                        background: rgba(52, 73, 94, 0.1);
                        border-radius: 12px;
                        color: #34495e;
                        font-weight: 500;
                    ">🎨 CSS3</span>
                    
                    <span style="
                        display: flex;
                        align-items: center;
                        gap: 5px;
                        padding: 5px 10px;
                        background: rgba(52, 73, 94, 0.1);
                        border-radius: 12px;
                        color: #34495e;
                        font-weight: 500;
                    ">💻 JavaScript ES6</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Estado global da aplicação
        let appState = {
            pdfData: null,
            candidatos: [],
            candidatosSelecionados: new Set(), // IDs dos candidatos selecionados
            motivosExclusao: {}, // ID -> motivo da exclusão
            vagaConfig: {},
            templateSelecionado: null,
            resultadosAnalise: {},
            coordenadasVaga: null
        };

        // Templates predefinidos
        const templates = {
            cnc_multifuncional: {
                nome: "Operador CNC Multifuncional",
                descricao: "Profissional versátil com experiência em múltiplas máquinas CNC",
                criterios: {
                    experiencia_cnc: { nome: "Experiência CNC", peso: 10, obrigatorio: true },
                    torno_cnc: { nome: "Torno CNC", peso: 8, obrigatorio: true },
                    centro_usinagem: { nome: "Centro de Usinagem", peso: 7, obrigatorio: false },
                    programacao_manual: { nome: "Programação Manual", peso: 6, obrigatorio: false },
                    setup_maquina: { nome: "Setup de Máquina", peso: 8, obrigatorio: true },
                    leitura_desenho: { nome: "Leitura Desenho Técnico", peso: 7, obrigatorio: true },
                    instrumentos_medicao: { nome: "Instrumentos de Medição", peso: 7, obrigatorio: true },
                    anos_experiencia: { nome: "Anos de Experiência", peso: 6, obrigatorio: false },
                    formacao_senai: { nome: "Formação SENAI", peso: 5, obrigatorio: false },
                    proximidade: { nome: "Proximidade da Vaga", peso: 3, obrigatorio: false }
                }
            },
            preparador_manual: {
                nome: "Preparador CNC Manual",
                descricao: "Especialista em programação manual e setup de máquinas",
                criterios: {
                    programacao_manual: { nome: "Programação Manual", peso: 10, obrigatorio: true },
                    codigos_g_m: { nome: "Códigos G/M", peso: 9, obrigatorio: true },
                    setup_maquina: { nome: "Setup de Máquina", peso: 9, obrigatorio: true },
                    fanuc_siemens: { nome: "Comandos Fanuc/Siemens", peso: 8, obrigatorio: true },
                    preset_ferramentas: { nome: "Preset de Ferramentas", peso: 8, obrigatorio: true },
                    experiencia_cnc: { nome: "Experiência CNC", peso: 8, obrigatorio: true },
                    leitura_desenho: { nome: "Leitura Desenho Técnico", peso: 7, obrigatorio: true },
                    programacao_cam: { nome: "Programação CAM", peso: 0, obrigatorio: false },
                    anos_experiencia: { nome: "Anos de Experiência", peso: 7, obrigatorio: false },
                    proximidade: { nome: "Proximidade da Vaga", peso: 3, obrigatorio: false }
                }
            },
            preparador_cam: {
                nome: "Preparador CNC CAM",
                descricao: "Especialista em programação via software CAM",
                criterios: {
                    programacao_cam: { nome: "Programação CAM", peso: 10, obrigatorio: true },
                    mastercam: { nome: "MasterCAM", peso: 9, obrigatorio: true },
                    powermill: { nome: "PowerMill", peso: 8, obrigatorio: false },
                    solidworks: { nome: "SolidWorks/CAD", peso: 7, obrigatorio: false },
                    setup_maquina: { nome: "Setup de Máquina", peso: 8, obrigatorio: true },
                    preset_ferramentas: { nome: "Preset de Ferramentas", peso: 8, obrigatorio: true },
                    experiencia_cnc: { nome: "Experiência CNC", peso: 7, obrigatorio: true },
                    programacao_manual: { nome: "Programação Manual", peso: 5, obrigatorio: false },
                    anos_experiencia: { nome: "Anos de Experiência", peso: 6, obrigatorio: false },
                    proximidade: { nome: "Proximidade da Vaga", peso: 3, obrigatorio: false }
                }
            },
            preparador_parametrizacao: {
                nome: "Preparador Parametrização/Macro",
                descricao: "Programação avançada com macros e parâmetros",
                criterios: {
                    programacao_macro: { nome: "Macro Programming", peso: 10, obrigatorio: true },
                    parametrizacao: { nome: "Parametrização", peso: 10, obrigatorio: true },
                    variaveis_sistema: { nome: "Variáveis de Sistema", peso: 9, obrigatorio: true },
                    subrotinas: { nome: "Subrotinas", peso: 9, obrigatorio: true },
                    calculos_trigonometria: { nome: "Cálculos/Trigonometria", peso: 8, obrigatorio: true },
                    programacao_condicional: { nome: "Programação Condicional", peso: 8, obrigatorio: true },
                    fanuc_macro_b: { nome: "Fanuc Macro B", peso: 9, obrigatorio: false },
                    siemens_cycles: { nome: "Siemens Cycles", peso: 8, obrigatorio: false },
                    setup_avancado: { nome: "Setup Avançado", peso: 8, obrigatorio: true },
                    anos_experiencia: { nome: "Anos de Experiência", peso: 7, obrigatorio: false },
                    proximidade: { nome: "Proximidade da Vaga", peso: 3, obrigatorio: false }
                }
            },
            centro_usinagem: {
                nome: "Operador Centro de Usinagem",
                descricao: "Especialista em centros de usinagem CNC",
                criterios: {
                    centro_usinagem: { nome: "Centro de Usinagem", peso: 10, obrigatorio: true },
                    programacao_cnc: { nome: "Programação CNC", peso: 8, obrigatorio: true },
                    setup_maquina: { nome: "Setup de Máquina", peso: 9, obrigatorio: true },
                    preset_ferramentas: { nome: "Preset de Ferramentas", peso: 8, obrigatorio: true },
                    usinagem_3_eixos: { nome: "Usinagem 3 Eixos", peso: 8, obrigatorio: true },
                    usinagem_4_5_eixos: { nome: "Usinagem 4/5 Eixos", peso: 6, obrigatorio: false },
                    leitura_desenho: { nome: "Leitura Desenho Técnico", peso: 8, obrigatorio: true },
                    instrumentos_medicao: { nome: "Instrumentos de Medição", peso: 7, obrigatorio: true },
                    anos_experiencia: { nome: "Anos de Experiência", peso: 6, obrigatorio: false },
                    proximidade: { nome: "Proximidade da Vaga", peso: 3, obrigatorio: false }
                }
            },
            torno_vertical: {
                nome: "Especialista Torno Vertical",
                descricao: "Especialização em tornos verticais de grande porte",
                criterios: {
                    torno_vertical: { nome: "Torno Vertical", peso: 10, obrigatorio: true },
                    grande_porte: { nome: "Peças Grande Porte", peso: 9, obrigatorio: true },
                    programacao_cnc: { nome: "Programação CNC", peso: 8, obrigatorio: true },
                    setup_complexo: { nome: "Setup Complexo", peso: 9, obrigatorio: true },
                    ponte_rolante: { nome: "Ponte Rolante", peso: 7, obrigatorio: false },
                    tolerancias_estreitas: { nome: "Tolerâncias Estreitas", peso: 8, obrigatorio: true },
                    experiencia_especializada: { nome: "Experiência Especializada", peso: 9, obrigatorio: true },
                    instrumentos_medicao: { nome: "Instrumentos de Medição", peso: 7, obrigatorio: true },
                    anos_experiencia: { nome: "Anos de Experiência", peso: 8, obrigatorio: false },
                    proximidade: { nome: "Proximidade da Vaga", peso: 3, obrigatorio: false }
                }
            }
        };

        // Dicionário para normalização de cidades com coordenadas mais precisas
        const normalizadorCidades = {
            dicionario: {
                "campo_limpo": ["campo limpo paulista", "campo limpo pta", "campo limpo", "clp"],
                "varzea_paulista": ["várzea paulista", "varzea paulista", "vp"],
                "jundiai": ["jundiaí", "jundiai", "jundiai sp"],
                "itupeva": ["itupeva", "itupeva sp"],
                "cajamar": ["cajamar", "cajamar sp"],
                "itatiba": ["itatiba", "itatiba sp"]
            },
            coordenadas: {
                // Coordenadas corrigidas para distâncias corretas
                "campo_limpo": { lat: -23.2109, lng: -46.7654 }, // Campo Limpo - mais distante de Jundiaí
                "varzea_paulista": { lat: -23.2108, lng: -46.8286 }, // Várzea Paulista - mais próxima de Jundiaí  
                "jundiai": { lat: -23.1864, lng: -46.8842 }, // Centro de Jundiaí
                "itupeva": { lat: -23.1486, lng: -47.0583 },
                "cajamar": { lat: -23.3553, lng: -46.8761 },
                "itatiba": { lat: -23.0056, lng: -46.8394 }
            },
            
            normalizar: function(endereco) {
                if (!endereco) return "outros";
                
                const limpo = endereco
                    .toLowerCase()
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "")
                    .replace(/[\/\-,]/g, " ")
                    .replace(/\s+/g, " ")
                    .trim();

                for (const [oficial, variacoes] of Object.entries(this.dicionario)) {
                    if (variacoes.some(variacao => limpo.includes(variacao))) {
                        return oficial;
                    }
                }
                
                return "outros";
            }
        };

        // === INICIALIZAÇÃO ===
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Sistema CV Analyzer inicializando...');
            
            try {
                carregarTemplatesPersonalizados(); // Carregar templates salvos primeiro
                console.log('✅ Templates personalizados carregados');
                
                carregarTemplates();
                console.log('✅ Templates padrão carregados');
                
                configurarEventos();
                console.log('✅ Eventos configurados');
                
                atualizarStatusEtapas(); // Atualizar status inicial
                console.log('✅ Status das etapas atualizado');
                
                console.log('🎉 Sistema CV Analyzer inicializado com sucesso!');
                
                // Verificação adicional após inicialização
                setTimeout(verificarInicializacao, 1000);
                
            } catch (error) {
                console.error('❌ Erro na inicialização:', error);
                alert('Erro na inicialização do sistema. Recarregue a página.');
            }
        });
        
        function verificarInicializacao() {
            const fileInput = document.getElementById('pdfFile');
            const uploadArea = document.querySelector('.upload-area');
            
            if (!fileInput || !uploadArea) {
                console.error('❌ Elementos críticos não encontrados após inicialização!');
                setTimeout(reconfigurarEventos, 500);
                return;
            }
            
            console.log('✅ Verificação de inicialização concluída - Sistema OK');
        }
        
        function reconfigurarEventos() {
            console.log('🔧 Reconfigurando eventos...');
            
            try {
                // Reconfigurar upload de arquivo
                const fileInput = document.getElementById('pdfFile');
                if (fileInput) {
                    // Método alternativo de configuração
                    fileInput.onchange = function(event) {
                        console.log('📁 Arquivo selecionado (método alternativo)');
                        handleFileUpload(event);
                    };
                    console.log('✅ Event listener do file input reconfigurado');
                }
                
                // Reconfigurar área de upload
                const uploadArea = document.querySelector('.upload-area');
                if (uploadArea) {
                    uploadArea.ondragover = function(event) {
                        event.preventDefault();
                        event.currentTarget.classList.add('dragover');
                    };
                    
                    uploadArea.ondragleave = function(event) {
                        event.currentTarget.classList.remove('dragover');
                    };
                    
                    uploadArea.ondrop = function(event) {
                        console.log('📁 Arquivo arrastado (método alternativo)');
                        handleFileDrop(event);
                    };
                    
                    // Garantir que clique também funcione
                    uploadArea.onclick = function() {
                        console.log('🖱️ Clique na área de upload detectado');
                        fileInput.click();
                    };
                    
                    console.log('✅ Event listeners da upload area reconfigurados');
                }
                
                console.log('✅ Reconfiguração concluída');
                
            } catch (error) {
                console.error('❌ Erro na reconfiguração:', error);
            }
        }
        
        function testarUpload() {
            console.log('🔧 === TESTE DO SISTEMA DE UPLOAD ===');
            
            const resultados = {
                pdfJsCarregado: typeof pdfjsLib !== 'undefined',
                fileInputExiste: !!document.getElementById('pdfFile'),
                uploadAreaExiste: !!document.querySelector('.upload-area'),
                eventListenersAtivos: false,
                estadoAplicacao: Object.keys(appState).length > 0
            };
            
            // Testar event listeners
            const fileInput = document.getElementById('pdfFile');
            const uploadArea = document.querySelector('.upload-area');
            
            if (fileInput) {
                // Verificar se há event listeners
                const hasListener = fileInput.onchange !== null;
                resultados.eventListenersAtivos = hasListener;
            }
            
            console.log('📊 Resultados do teste:', resultados);
            
            // Criar relatório visual
            let relatorio = '🔧 TESTE DO SISTEMA DE UPLOAD\n\n';
            relatorio += `📚 PDF.js carregado: ${resultados.pdfJsCarregado ? '✅ SIM' : '❌ NÃO'}\n`;
            relatorio += `📄 Input de arquivo existe: ${resultados.fileInputExiste ? '✅ SIM' : '❌ NÃO'}\n`;
            relatorio += `📂 Área de upload existe: ${resultados.uploadAreaExiste ? '✅ SIM' : '❌ NÃO'}\n`;
            relatorio += `🔗 Event listeners ativos: ${resultados.eventListenersAtivos ? '✅ SIM' : '❌ NÃO'}\n`;
            relatorio += `🏗️ Estado da aplicação OK: ${resultados.estadoAplicacao ? '✅ SIM' : '❌ NÃO'}\n\n`;
            
            // Verificar problemas e sugestões
            const problemas = [];
            if (!resultados.pdfJsCarregado) problemas.push('PDF.js não carregou');
            if (!resultados.fileInputExiste) problemas.push('Input de arquivo não encontrado');
            if (!resultados.uploadAreaExiste) problemas.push('Área de upload não encontrada');
            if (!resultados.eventListenersAtivos) problemas.push('Event listeners podem não estar ativos');
            
            if (problemas.length > 0) {
                relatorio += '⚠️ PROBLEMAS ENCONTRADOS:\n';
                problemas.forEach(problema => relatorio += `• ${problema}\n`);
                relatorio += '\n🔧 TENTANDO CORRIGIR...\n';
                
                // Tentar corrigir
                reconfigurarEventos();
                relatorio += '✅ Reconfiguração executada!\n';
            } else {
                relatorio += '✅ SISTEMA OK - Tente fazer upload de um PDF\n';
            }
            
            relatorio += '\n💡 Se ainda não funcionar:\n';
            relatorio += '• Recarregue a página (F5)\n';
            relatorio += '• Verifique se o arquivo é realmente um PDF\n';
            relatorio += '• Abra o Console (F12) para ver detalhes\n';
            
            alert(relatorio);
            
            // Log detalhado no console
            console.log('🔍 Teste detalhado concluído. Verifique o relatório acima.');
            console.log('📋 AppState atual:', appState);
            console.log('🔧 === FIM DO TESTE ===');
        }

        // === FUNÇÕES DE CONFIGURAÇÃO E EVENTOS ===
        function configurarEventos() {
            console.log('🔧 Configurando eventos...');
            
            // Upload de arquivo
            const fileInput = document.getElementById('pdfFile');
            if (fileInput) {
                // Remover event listeners existentes primeiro
                fileInput.removeEventListener('change', handleFileUpload);
                fileInput.addEventListener('change', handleFileUpload);
                console.log('✅ Event listener do file input configurado');
            } else {
                console.error('❌ Elemento pdfFile não encontrado!');
            }
            
            // Drag and drop
            const uploadArea = document.querySelector('.upload-area');
            if (uploadArea) {
                // Remover event listeners existentes primeiro
                uploadArea.removeEventListener('dragover', handleDragOver);
                uploadArea.removeEventListener('dragleave', handleDragLeave);
                uploadArea.removeEventListener('drop', handleFileDrop);
                
                // Adicionar event listeners
                uploadArea.addEventListener('dragover', handleDragOver);
                uploadArea.addEventListener('dragleave', handleDragLeave);
                uploadArea.addEventListener('drop', handleFileDrop);
                console.log('✅ Event listeners de drag&drop configurados');
            } else {
                console.error('❌ Elemento upload-area não encontrado!');
            }
        }

        function showTab(tabName) {
            console.log(`🔄 Mudando para aba: ${tabName}`);
            
            // Ocultar todas as abas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar aba selecionada
            const targetTab = document.getElementById(tabName);
            const targetButton = document.querySelector(`[onclick="showTab('${tabName}')"]`);
            
            if (targetTab) {
                targetTab.classList.add('active');
            } else {
                console.error(`❌ Aba ${tabName} não encontrada!`);
                return;
            }
            
            if (targetButton) {
                targetButton.classList.add('active');
            } else {
                console.error(`❌ Botão da aba ${tabName} não encontrado!`);
            }
            
            // Inicialização específica por aba
            try {
                if (tabName === 'upload') {
                    // Garantir que upload funcione quando voltar para esta aba
                    setTimeout(() => {
                        const fileInput = document.getElementById('pdfFile');
                        const uploadArea = document.querySelector('.upload-area');
                        
                        if (!fileInput || !uploadArea) {
                            console.log('⚠️ Elementos de upload não encontrados, reconfigurando...');
                            reconfigurarEventos();
                        }
                    }, 100);
                    
                } else if (tabName === 'selecao') {
                    setTimeout(inicializarAbaSeleção, 100);
                    
                } else if (tabName === 'templates') {
                    setTimeout(atualizarStatusEtapas, 100);
                }
                
                console.log(`✅ Aba ${tabName} carregada com sucesso`);
                
            } catch (error) {
                console.error(`❌ Erro ao inicializar aba ${tabName}:`, error);
            }
        }

        // === FUNÇÕES DE UPLOAD E PROCESSAMENTO ===
        function handleFileUpload(event) {
            console.log('📁 Arquivo selecionado via input');
            const file = event.target.files[0];
            
            if (!file) {
                console.log('❌ Nenhum arquivo selecionado');
                return;
            }
            
            console.log('📄 Arquivo:', file.name, 'Tipo:', file.type, 'Tamanho:', file.size);
            
            if (file.type === 'application/pdf') {
                console.log('✅ Arquivo PDF válido, iniciando processamento...');
                processarPDF(file);
            } else {
                console.log('❌ Tipo de arquivo inválido:', file.type);
                alert('Por favor, selecione um arquivo PDF válido.');
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function handleFileDrop(event) {
            console.log('📁 Arquivo arrastado para upload area');
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            console.log('📂 Arquivos arrastados:', files.length);
            
            if (files.length > 0) {
                const file = files[0];
                console.log('📄 Primeiro arquivo:', file.name, 'Tipo:', file.type);
                
                if (file.type === 'application/pdf') {
                    console.log('✅ Arquivo PDF válido via drag&drop, iniciando processamento...');
                    document.getElementById('pdfFile').files = files;
                    processarPDF(file);
                } else {
                    console.log('❌ Tipo de arquivo inválido via drag&drop:', file.type);
                    alert('Por favor, arraste um arquivo PDF válido.');
                }
            } else {
                console.log('❌ Nenhum arquivo foi arrastado');
                alert('Por favor, arraste um arquivo PDF válido.');
            }
        }

        async function processarPDF(file) {
            console.log('🔍 Iniciando processamento do PDF:', file.name);
            
            // Verificar se PDF.js está carregado
            if (typeof pdfjsLib === 'undefined') {
                console.error('❌ PDF.js não está carregado!');
                alert('Erro: Biblioteca PDF.js não carregada. Recarregue a página e tente novamente.');
                return;
            }
            
            // Mostrar loading
            const loadingElement = document.getElementById('loadingPDF');
            const fileInfoElement = document.getElementById('fileInfo');
            const fileNameElement = document.getElementById('fileName');
            
            if (loadingElement) loadingElement.classList.add('show');
            if (fileInfoElement) fileInfoElement.classList.remove('hidden');
            if (fileNameElement) fileNameElement.textContent = file.name;
            
            try {
                console.log('📖 Convertendo arquivo para ArrayBuffer...');
                const arrayBuffer = await file.arrayBuffer();
                console.log('✅ ArrayBuffer criado, tamanho:', arrayBuffer.byteLength);
                
                console.log('📚 Carregando PDF com PDF.js...');
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                console.log(`✅ PDF carregado com ${pdf.numPages} páginas`);
                
                // Processar TODAS as páginas para extrair candidatos
                let textoCompleto = '';
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    console.log(`📄 Processando página ${i}/${pdf.numPages}...`);
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const textoPagina = textContent.items.map(item => item.str).join(' ');
                    textoCompleto += textoPagina + ' ';
                    
                    // Atualizar status
                    const statusElement = document.querySelector('#loadingPDF p');
                    if (statusElement) {
                        statusElement.textContent = `Processando página ${i}/${pdf.numPages}... Extraindo texto...`;
                    }
                }
                
                console.log(`✅ Texto total extraído: ${textoCompleto.length} caracteres`);
                
                if (textoCompleto.length < 100) {
                    throw new Error('PDF parece estar vazio ou com pouco conteúdo');
                }
                
                // Atualizar status
                const statusElement = document.querySelector('#loadingPDF p');
                if (statusElement) {
                    statusElement.textContent = 'Identificando candidatos...';
                }
                
                // Extrair candidatos do texto completo
                const candidatos = extrairCandidatos(textoCompleto);
                
                if (candidatos.length === 0) {
                    throw new Error('Nenhum candidato foi encontrado no PDF');
                }
                
                // Salvar dados
                appState.pdfData = arrayBuffer;
                appState.candidatos = candidatos;
                
                console.log(`✅ PDF processado com sucesso: ${candidatos.length} candidatos encontrados`);
                
                // Mostrar resultados
                if (loadingElement) loadingElement.classList.remove('show');
                exibirCandidatos(candidatos);
                
            } catch (error) {
                console.error('❌ Erro ao processar PDF:', error);
                
                // Ocultar loading
                if (loadingElement) loadingElement.classList.remove('show');
                
                // Mostrar erro mais detalhado
                let mensagemErro = 'Erro ao processar o PDF:\n\n';
                
                if (error.message.includes('vazio')) {
                    mensagemErro += '• O PDF parece estar vazio ou não contém texto extraível\n';
                    mensagemErro += '• Verifique se é um PDF com texto (não apenas imagens)\n';
                } else if (error.message.includes('Nenhum candidato')) {
                    mensagemErro += '• Não foi possível encontrar candidatos no formato esperado\n';
                    mensagemErro += '• Verifique se o PDF contém lista numerada com padrão: "1. Nome Candidato Cand-12345"\n';
                } else if (error.name === 'InvalidPDFException') {
                    mensagemErro += '• O arquivo não é um PDF válido ou está corrompido\n';
                } else if (error.name === 'MissingPDFException') {
                    mensagemErro += '• Arquivo PDF não encontrado ou não pode ser lido\n';
                } else {
                    mensagemErro += `• ${error.message}\n`;
                    mensagemErro += '• Verifique se o arquivo não está corrompido\n';
                }
                
                mensagemErro += '\n💡 Sugestões:\n';
                mensagemErro += '• Tente novamente com outro arquivo PDF\n';
                mensagemErro += '• Verifique o formato do PDF (deve conter texto, não só imagens)\n';
                mensagemErro += '• Use o botão "Testar Sistema" para verificar problemas\n';
                
                alert(mensagemErro);
            }
        }

        function limparNome(nome) {
            if (!nome) return "";
            
            // Primeiro, fazer limpeza básica
            let nomeBasico = nome
                .replace(/\s+/g, ' ') // Múltiplos espaços para um só
                .replace(/[^\w\sÀ-ÿ]/g, ' ') // Remove caracteres especiais mas mantém acentos
                .trim();
            
            // Verificar se o nome REALMENTE tem problemas antes de aplicar limpeza pesada
            const palavras = nomeBasico.toLowerCase().split(' ').filter(p => p.length > 0);
            
            // Detectar problemas comuns
            const temDuplicacaoConsecutiva = palavras.some((palavra, i) => 
                i > 0 && palavra === palavras[i-1] && !['de', 'da', 'do', 'das', 'dos'].includes(palavra)
            );
            
            const temDuplicacaoDistante = palavras.some((palavra, i) => 
                palavras.indexOf(palavra) !== i && !['de', 'da', 'do', 'das', 'dos', 'e', 'a', 'o'].includes(palavra)
            );
            
            const temNomeIncompleto = nomeBasico.endsWith(' da') || nomeBasico.endsWith(' de') || 
                                    nomeBasico.endsWith(' do') || nomeBasico.endsWith(' dos') || 
                                    nomeBasico.endsWith(' das');
            
            // SE NÃO TEM PROBLEMAS, retornar apenas com capitalização correta
            if (!temDuplicacaoConsecutiva && !temDuplicacaoDistante && !temNomeIncompleto) {
                // Apenas capitalizar corretamente e retornar
                return nomeBasico.split(' ').map(palavra => {
                    if (['de', 'da', 'do', 'das', 'dos', 'e'].includes(palavra.toLowerCase()) && palavra.length <= 3) {
                        return palavra.toLowerCase();
                    }
                    return palavra.charAt(0).toUpperCase() + palavra.slice(1).toLowerCase();
                }).join(' ');
            }
            
            // SE TEM PROBLEMAS, aplicar limpeza pesada
            console.log(`🔧 Aplicando limpeza pesada em: "${nome}" (problemas detectados)`);
            
            let palavrasLimpas = [];
            
            // Remover duplicações consecutivas
            for (let i = 0; i < palavras.length; i++) {
                const palavraAtual = palavras[i];
                const palavraAnterior = palavrasLimpas[palavrasLimpas.length - 1];
                
                if (palavraAtual !== palavraAnterior) {
                    palavrasLimpas.push(palavraAtual);
                }
            }
            
            // Remover duplicações não consecutivas (exceto preposições)
            let palavrasFinais = [];
            for (let i = 0; i < palavrasLimpas.length; i++) {
                const palavra = palavrasLimpas[i];
                const preposicoes = ['de', 'da', 'do', 'das', 'dos', 'e', 'a', 'o'];
                const jaExiste = palavrasFinais.includes(palavra);
                const ehPreposicao = preposicoes.includes(palavra);
                
                if (!jaExiste || ehPreposicao) {
                    palavrasFinais.push(palavra);
                }
            }
            
            // Remover preposições órfãs no final
            while (palavrasFinais.length > 0 && 
                   ['de', 'da', 'do', 'das', 'dos'].includes(palavrasFinais[palavrasFinais.length - 1])) {
                palavrasFinais.pop();
            }
            
            // Capitalizar
            palavrasFinais = palavrasFinais.map(palavra => {
                if (['de', 'da', 'do', 'das', 'dos', 'e'].includes(palavra) && palavra.length <= 3) {
                    return palavra;
                } else {
                    return palavra.charAt(0).toUpperCase() + palavra.slice(1);
                }
            });
            
            const nomeClean = palavrasFinais.join(' ');
            
            // Validação final
            if (nomeClean.length < 3 || palavrasFinais.length < 2) {
                console.log(`❌ Nome inválido após limpeza: "${nomeClean}"`);
                return "";
            }
            
            console.log('✅ Nome corrigido: "${nome}" → "${nomeClean}"');
            return nomeClean;
        }

        function extrairCandidatos(texto) {
            const candidatos = [];
            
            // Regex melhorada para capturar nomes mais precisamente
            const regexPrincipal = /(\d+)\.\s*([A-ZÀ-Ÿ][A-ZÀ-Ÿa-zà-ÿ\s]{3,80}?)\s+(Cand-\d+)/gi;
            
            const nomesEncontrados = new Set();
            const idsEncontrados = new Set();
            let match;
            
            // Reset regex
            regexPrincipal.lastIndex = 0;
            
            console.log('Iniciando extração de candidatos...');
            
            while ((match = regexPrincipal.exec(texto)) !== null) {
                const numero = parseInt(match[1]);
                let nomeRaw = match[2].trim();
                const id = match[3];
                
                // Evitar IDs duplicados
                if (idsEncontrados.has(id)) {
                    continue;
                }
                
                // Limpar o nome usando a função especializada
                const nomeClean = limparNome(nomeRaw);
                
                // Verificar se o nome é válido
                if (nomeClean.length < 3) {
                    console.log(`Nome inválido ignorado: "${nomeRaw}" -> "${nomeClean}"`);
                    continue;
                }
                
                // Verificar duplicações de nomes (case insensitive)
                const nomeKey = nomeClean.toLowerCase();
                if (nomesEncontrados.has(nomeKey)) {
                    console.log(`Nome duplicado ignorado: "${nomeClean}"`);
                    continue;
                }
                
                nomesEncontrados.add(nomeKey);
                idsEncontrados.add(id);
                
                candidatos.push({
                    numero: numero,
                    nome: nomeClean,
                    id: id,
                    pontuacao: 0,
                    detalhes: {},
                    endereco: "",
                    cidade_normalizada: "",
                    distancia: 0,
                    competencias: []
                });
                
                console.log(`✅ Candidato ${numero}: "${nomeClean}" (${id})`);
            }
            
            // Se ainda não encontrou todos, tentar regex mais ampla
            if (candidatos.length < 50) {
                console.log('Executando busca complementar...');
                
                const regexComplementar = /(\d+)\.\s*([A-ZÀ-Ÿ][^0-9\n]{4,60}?)\s+(Cand-\d+)/gi;
                regexComplementar.lastIndex = 0;
                
                while ((match = regexComplementar.exec(texto)) !== null) {
                    const numero = parseInt(match[1]);
                    let nomeRaw = match[2].trim();
                    const id = match[3];
                    
                    // Pular se já foi encontrado
                    if (idsEncontrados.has(id)) {
                        continue;
                    }
                    
                    const nomeClean = limparNome(nomeRaw);
                    
                    if (nomeClean.length < 3) {
                        continue;
                    }
                    
                    const nomeKey = nomeClean.toLowerCase();
                    if (nomesEncontrados.has(nomeKey)) {
                        continue;
                    }
                    
                    nomesEncontrados.add(nomeKey);
                    idsEncontrados.add(id);
                    
                    candidatos.push({
                        numero: numero,
                        nome: nomeClean,
                        id: id,
                        pontuacao: 0,
                        detalhes: {},
                        endereco: "",
                        cidade_normalizada: "",
                        distancia: 0,
                        competencias: []
                    });
                    
                    console.log(`✅ Candidato complementar ${numero}: "${nomeClean}" (${id})`);
                }
            }
            
            // Ordenar por número
            candidatos.sort((a, b) => a.numero - b.numero);
            
            console.log(`Extração concluída: ${candidatos.length} candidatos válidos`);
            console.log('Primeiros 5 candidatos:', candidatos.slice(0, 5).map(c => `${c.numero}. ${c.nome} ${c.id}`));
            
            return candidatos;
        }

        function exibirCandidatos(candidatos) {
            document.getElementById('candidatesList').classList.remove('hidden');
            document.getElementById('candidatesCount').innerHTML = 
                `<strong>✅ ${candidatos.length} candidatos encontrados no PDF</strong>`;
            
            const preview = document.getElementById('candidatesPreview');
            const primeiros10 = candidatos.slice(0, 10);
            
            preview.innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <strong>📋 Prévia dos primeiros 10 candidatos:</strong><br>
                    ${primeiros10.map(c => `• ${c.nome} (${c.id})`).join('<br>')}
                    ${candidatos.length > 10 ? `<br><em>... e mais ${candidatos.length - 10} candidatos</em>` : ''}
                </div>
            `;
            
            // Inicializar seleção de todos os candidatos
            appState.candidatosSelecionados.clear();
            candidatos.forEach(candidato => {
                appState.candidatosSelecionados.add(candidato.id);
            });
            
            // Atualizar status das etapas
            atualizarStatusEtapas();
            
            console.log('✅ Candidatos exibidos e selecionados por padrão');
        }

        // === FUNÇÕES DE SELEÇÃO DE CANDIDATOS ===
        function inicializarAbaSeleção() {
            if (appState.candidatos.length === 0) {
                document.getElementById('listaCandidatos').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                        📋 Nenhum candidato carregado. Por favor, faça o upload do PDF primeiro.
                    </div>
                `;
                return;
            }
            
            // Se primeira vez na aba, inicializar todos selecionados
            if (appState.candidatosSelecionados.size === 0) {
                appState.candidatos.forEach(candidato => {
                    appState.candidatosSelecionados.add(candidato.id);
                });
            }
            
            atualizarListaCandidatos();
            console.log('👥 Aba de seleção inicializada');
        }

        function atualizarListaCandidatos() {
            const lista = document.getElementById('listaCandidatos');
            if (!lista) return;
            
            const candidatos = appState.candidatos || [];
            const filtroDistancia = document.getElementById('filtroDistancia')?.value || 'todos';
            const buscaTexto = document.getElementById('buscaCandidato')?.value.toLowerCase() || '';
            
            // Aplicar filtros
            let candidatosFiltrados = candidatos.filter(candidato => {
                // Filtro de busca
                const nomeMatch = candidato.nome.toLowerCase().includes(buscaTexto);
                const idMatch = candidato.id.toLowerCase().includes(buscaTexto);
                if (!nomeMatch && !idMatch) return false;
                
                // Filtro de distância (simulado por enquanto)
                if (filtroDistancia !== 'todos') {
                    const distanciaMax = parseInt(filtroDistancia);
                    const distanciaCandidato = candidato.distancia || Math.random() * 50; // Simulado
                    if (distanciaCandidato > distanciaMax) return false;
                }
                
                return true;
            });
            
            if (candidatosFiltrados.length === 0) {
                lista.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                        🔍 Nenhum candidato encontrado com os filtros aplicados
                    </div>
                `;
                return;
            }
            
            lista.innerHTML = candidatosFiltrados.map(candidato => {
                const selecionado = appState.candidatosSelecionados.has(candidato.id);
                const motivo = appState.motivosExclusao[candidato.id] || '';
                const distancia = candidato.distancia || (Math.random() * 40 + 2).toFixed(1); // Simulado
                
                return `
                    <div style="
                        display: flex;
                        align-items: flex-start;
                        padding: 15px;
                        margin-bottom: 10px;
                        background: ${selecionado ? '#f8fff8' : '#fff5f5'};
                        border: 2px solid ${selecionado ? '#2ecc71' : '#e74c3c'};
                        border-radius: 8px;
                        transition: all 0.3s ease;
                    ">
                        <div style="margin-right: 15px; margin-top: 5px;">
                            <input type="checkbox" 
                                   id="check-${candidato.id}"
                                   ${selecionado ? 'checked' : ''}
                                   onchange="toggleCandidato('${candidato.id}')"
                                   style="transform: scale(1.3);">
                        </div>
                        
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: ${selecionado ? '#2c3e50' : '#7f8c8d'}; margin-bottom: 5px;">
                                ${candidato.numero}. ${candidato.nome}
                            </div>
                            <div style="color: #7f8c8d; font-size: 0.9em; margin-bottom: 5px;">
                                📍 ${candidato.endereco || 'Endereço simulado'} • ${candidato.id} • ${distancia}km
                            </div>
                            
                            ${!selecionado ? `
                                <div style="margin-top: 10px;">
                                    <input type="text" 
                                           placeholder="Motivo da exclusão (opcional)"
                                           value="${motivo}"
                                           onchange="atualizarMotivo('${candidato.id}', this.value)"
                                           style="
                                               width: 100%;
                                               padding: 6px;
                                               border: 1px solid #ddd;
                                               border-radius: 4px;
                                               font-size: 0.85em;
                                               background: #fffbf0;
                                           ">
                                </div>
                            ` : ''}
                        </div>
                        
                        <div style="margin-left: 15px; text-align: center;">
                            <div style="
                                font-size: 1.5em;
                                margin-bottom: 5px;
                            ">${selecionado ? '✅' : '❌'}</div>
                            <div style="
                                font-size: 0.75em;
                                color: ${selecionado ? '#2ecc71' : '#e74c3c'};
                                font-weight: bold;
                            ">${selecionado ? 'INCLUÍDO' : 'EXCLUÍDO'}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            atualizarContadores();
        }
        
        function toggleCandidato(candidatoId) {
            if (appState.candidatosSelecionados.has(candidatoId)) {
                appState.candidatosSelecionados.delete(candidatoId);
            } else {
                appState.candidatosSelecionados.add(candidatoId);
                // Limpar motivo se foi re-incluído
                delete appState.motivosExclusao[candidatoId];
            }
            
            atualizarListaCandidatos();
            console.log(`Candidato ${candidatoId} ${appState.candidatosSelecionados.has(candidatoId) ? 'incluído' : 'excluído'}`);
        }
        
        function atualizarMotivo(candidatoId, motivo) {
            if (motivo.trim()) {
                appState.motivosExclusao[candidatoId] = motivo.trim();
            } else {
                delete appState.motivosExclusao[candidatoId];
            }
            console.log(`Motivo atualizado para ${candidatoId}:`, motivo);
        }
        
        function selecionarTodos() {
            appState.candidatosSelecionados.clear();
            appState.candidatos.forEach(candidato => {
                appState.candidatosSelecionados.add(candidato.id);
            });
            
            // Limpar motivos de exclusão
            appState.motivosExclusao = {};
            
            atualizarListaCandidatos();
            console.log('✅ Todos os candidatos selecionados');
        }
        
        function desmarcarTodos() {
            appState.candidatosSelecionados.clear();
            atualizarListaCandidatos();
            console.log('❌ Todos os candidatos desmarcados');
        }
        
        function inverterSelecao() {
            const novaSelecao = new Set();
            appState.candidatos.forEach(candidato => {
                if (!appState.candidatosSelecionados.has(candidato.id)) {
                    novaSelecao.add(candidato.id);
                }
            });
            
            appState.candidatosSelecionados = novaSelecao;
            atualizarListaCandidatos();
            console.log('🔄 Seleção invertida');
        }
        
        function aplicarFiltros() {
            atualizarListaCandidatos();
        }
        
        function atualizarContadores() {
            const total = appState.candidatos.length;
            const selecionados = appState.candidatosSelecionados.size;
            const excluidos = total - selecionados;
            
            const elementoTotal = document.getElementById('totalCandidatos');
            const elementoSelecionados = document.getElementById('candidatosSelecionados');
            const elementoExcluidos = document.getElementById('candidatosExcluidos');
            
            if (elementoTotal) elementoTotal.textContent = total;
            if (elementoSelecionados) elementoSelecionados.textContent = selecionados;
            if (elementoExcluidos) elementoExcluidos.textContent = excluidos;
        }

        // === FUNÇÕES DE TEMPLATES ===
        function carregarTemplatesPersonalizados() {
            try {
                const templatesPersonalizados = JSON.parse(localStorage.getItem('templatesPersonalizados') || '{}');
                
                // Adicionar templates personalizados ao objeto global
                Object.entries(templatesPersonalizados).forEach(([chave, template]) => {
                    templates[chave] = template;
                });
                
                console.log(`📋 ${Object.keys(templatesPersonalizados).length} templates personalizados carregados`);
                
            } catch (error) {
                console.error('Erro ao carregar templates personalizados:', error);
            }
        }

        function carregarTemplates() {
            const grid = document.getElementById('templatesGrid');
            grid.innerHTML = '';
            
            // Separar templates padrão dos personalizados
            const templatesEstaticos = {};
            const templatesPersonalizados = {};
            
            Object.entries(templates).forEach(([key, template]) => {
                if (key.startsWith('custom_')) {
                    templatesPersonalizados[key] = template;
                } else {
                    templatesEstaticos[key] = template;
                }
            });
            
            // Renderizar templates padrão primeiro
            Object.entries(templatesEstaticos).forEach(([key, template]) => {
                const card = document.createElement('div');
                card.className = 'template-card';
                card.onclick = () => selecionarTemplate(key);
                
                const criteriosTexto = Object.keys(template.criterios)
                    .filter(c => template.criterios[c].peso > 0)
                    .slice(0, 4)
                    .map(c => template.criterios[c].nome)
                    .join(', ');
                
                card.innerHTML = `
                    <div class="template-title">${template.nome}</div>
                    <div class="template-description">${template.descricao}</div>
                    <div class="template-criterios">
                        <strong>Principais critérios:</strong> ${criteriosTexto}...
                    </div>
                `;
                
                grid.appendChild(card);
            });
            
            // Se houver templates personalizados, adicionar seção separada
            if (Object.keys(templatesPersonalizados).length > 0) {
                // Divisor
                const divisor = document.createElement('div');
                divisor.style.cssText = `
                    grid-column: 1 / -1;
                    margin: 20px 0;
                    text-align: center;
                    color: #7f8c8d;
                    font-weight: bold;
                    border-top: 2px solid #ecf0f1;
                    padding-top: 20px;
                `;
                divisor.innerHTML = '📋 MEUS TEMPLATES PERSONALIZADOS';
                grid.appendChild(divisor);
                
                // Renderizar templates personalizados
                Object.entries(templatesPersonalizados).forEach(([key, template]) => {
                    const card = document.createElement('div');
                    card.className = 'template-card';
                    card.style.borderLeft = '5px solid #2ecc71'; // Verde para personalizados
                    card.onclick = () => selecionarTemplate(key);
                    
                    const criteriosTexto = Object.keys(template.criterios)
                        .filter(c => template.criterios[c].peso > 0)
                        .slice(0, 4)
                        .map(c => template.criterios[c].nome)
                        .join(', ');
                    
                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div class="template-title">
                                    ${template.nome} 
                                    <span style="font-size: 0.8em; color: #2ecc71;">👤 Personalizado</span>
                                </div>
                                <div class="template-description">${template.descricao}</div>
                                <div class="template-criterios">
                                    <strong>Principais critérios:</strong> ${criteriosTexto}...
                                </div>
                                <div style="font-size: 0.8em; color: #95a5a6; margin-top: 8px;">
                                    📅 Criado em: ${template.dataCreated}
                                </div>
                            </div>
                            <button onclick="event.stopPropagation(); excluirTemplate('${key}')" 
                                    style="
                                        background: #e74c3c; 
                                        color: white; 
                                        border: none; 
                                        border-radius: 50%; 
                                        width: 25px; 
                                        height: 25px; 
                                        cursor: pointer;
                                        font-size: 12px;
                                    ">🗑️</button>
                        </div>
                    `;
                    
                    grid.appendChild(card);
                });
            }
        }

        function selecionarTemplate(templateKey) {
            console.log('📋 Selecionando template:', templateKey);
            
            // Marcar template selecionado
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            appState.templateSelecionado = templateKey;
            console.log('✅ Template selecionado:', appState.templateSelecionado);
            
            // Mostrar editor
            document.getElementById('templateEditor').classList.remove('hidden');
            carregarEditor(templates[templateKey]);
            
            // Mostrar feedback visual
            const templateNome = templates[templateKey].nome;
            
            // Criar ou atualizar mensagem de confirmação
            let confirmacao = document.getElementById('template-confirmacao');
            if (!confirmacao) {
                confirmacao = document.createElement('div');
                confirmacao.id = 'template-confirmacao';
                confirmacao.style.cssText = `
                    background: #d4edda;
                    color: #155724;
                    padding: 15px;
                    border-radius: 8px;
                    margin: 15px 0;
                    border-left: 4px solid #28a745;
                    font-weight: bold;
                `;
                document.getElementById('templates').appendChild(confirmacao);
            }
            
            confirmacao.innerHTML = `✅ <strong>Template selecionado:</strong> ${templateNome}`;
            
            // Atualizar status das etapas
            atualizarStatusEtapas();
        }

        function carregarEditor(template) {
            const editor = document.getElementById('criteriosEditor');
            editor.innerHTML = '';
            
            Object.entries(template.criterios).forEach(([key, criterio]) => {
                const item = document.createElement('div');
                item.className = 'criterio-item';
                
                item.innerHTML = `
                    <div class="criterio-nome">${criterio.nome}</div>
                    <div class="criterio-controls">
                        <input type="range" 
                               class="peso-slider" 
                               min="0" max="10" 
                               value="${criterio.peso}"
                               oninput="atualizarPeso('${key}', this.value)">
                        <span class="peso-value" id="peso-${key}">${criterio.peso}</span>
                        <label>
                            <input type="checkbox" 
                                   class="obrigatorio-checkbox"
                                   ${criterio.obrigatorio ? 'checked' : ''}
                                   onchange="atualizarObrigatorio('${key}', this.checked)">
                            Obrigatório
                        </label>
                    </div>
                `;
                
                editor.appendChild(item);
            });
        }

        function atualizarPeso(criterio, valor) {
            templates[appState.templateSelecionado].criterios[criterio].peso = parseInt(valor);
            document.getElementById(`peso-${criterio}`).textContent = valor;
        }

        function atualizarObrigatorio(criterio, valor) {
            templates[appState.templateSelecionado].criterios[criterio].obrigatorio = valor;
        }

        function resetTemplate() {
            if (appState.templateSelecionado) {
                carregarEditor(templates[appState.templateSelecionado]);
            }
        }

        function salvarTemplate() {
            if (!appState.templateSelecionado) {
                alert('❌ Nenhum template selecionado para personalizar.');
                return;
            }
            
            // Pedir nome para o template personalizado
            const nomeTemplate = prompt('📝 Digite um nome para seu template personalizado:', 
                `${templates[appState.templateSelecionado].nome} - Personalizado`);
            
            if (!nomeTemplate || nomeTemplate.trim() === '') {
                return; // Usuário cancelou
            }
            
            try {
                // Clonar o template atual com as modificações
                const templatePersonalizado = {
                    nome: nomeTemplate.trim(),
                    descricao: `Template personalizado baseado em ${templates[appState.templateSelecionado].nome}`,
                    criterios: JSON.parse(JSON.stringify(templates[appState.templateSelecionado].criterios)),
                    dataCreated: new Date().toLocaleDateString('pt-BR'),
                    baseTemplate: appState.templateSelecionado
                };
                
                // Salvar no localStorage (simulando persistência)
                let templatesPersonalizados = JSON.parse(localStorage.getItem('templatesPersonalizados') || '{}');
                const chaveTemplate = `custom_${Date.now()}`;
                templatesPersonalizados[chaveTemplate] = templatePersonalizado;
                localStorage.setItem('templatesPersonalizados', JSON.stringify(templatesPersonalizados));
                
                // Adicionar ao templates global para uso imediato
                templates[chaveTemplate] = templatePersonalizado;
                
                // Feedback visual
                const alertDiv = document.createElement('div');
                alertDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #2ecc71;
                    color: white;
                    padding: 15px 25px;
                    border-radius: 8px;
                    z-index: 9999;
                    font-weight: bold;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                `;
                alertDiv.innerHTML = `
                    ✅ Template "${nomeTemplate}" salvo com sucesso!<br>
                    <small style="opacity: 0.8;">💾 Disponível neste navegador</small>
                `;
                document.body.appendChild(alertDiv);
                
                // Remover após 3 segundos
                setTimeout(() => {
                    alertDiv.remove();
                }, 3000);
                
                // Recarregar grid de templates para mostrar o novo
                carregarTemplates();
                
                console.log('✅ Template personalizado salvo:', templatePersonalizado);
                
            } catch (error) {
                console.error('Erro ao salvar template:', error);
                alert('❌ Erro ao salvar template. Tente novamente.');
            }
        }

        function excluirTemplate(templateKey) {
            if (!templateKey.startsWith('custom_')) {
                alert('❌ Não é possível excluir templates padrão do sistema.');
                return;
            }
            
            if (confirm('🗑️ Tem certeza que deseja excluir este template personalizado?')) {
                try {
                    // Remover do localStorage
                    let templatesPersonalizados = JSON.parse(localStorage.getItem('templatesPersonalizados') || '{}');
                    delete templatesPersonalizados[templateKey];
                    localStorage.setItem('templatesPersonalizados', JSON.stringify(templatesPersonalizados));
                    
                    // Remover do objeto global
                    delete templates[templateKey];
                    
                    // Recarregar grid
                    carregarTemplates();
                    
                    alert('✅ Template excluído com sucesso!');
                    
                } catch (error) {
                    console.error('Erro ao excluir template:', error);
                    alert('❌ Erro ao excluir template.');
                }
            }
        }

        // === FUNÇÕES DE CONFIGURAÇÃO DA VAGA ===
        function validarEndereco() {
            console.log('📍 Validando endereço...');
            
            const endereco = document.getElementById('enderecoVaga').value;
            if (!endereco) {
                alert('Por favor, insira um endereço.');
                return;
            }
            
            console.log('Endereço informado:', endereco);
            
            try {
                // Simular validação de endereço (em produção, usar API de geocoding)
                const cidade = normalizadorCidades.normalizar(endereco);
                let coordenadas = normalizadorCidades.coordenadas[cidade];
                
                console.log('Cidade normalizada:', cidade);
                
                // Se for Jundiaí, ajustar para região industrial (como KSB)
                if (cidade === 'jundiai') {
                    coordenadas = { lat: -23.1950, lng: -46.8950 }; // Região industrial de Jundiaí
                    console.log('Ajustado para região industrial de Jundiaí');
                }
                
                // Fallback para centro de Jundiaí se não reconhecer a cidade
                if (!coordenadas) {
                    coordenadas = { lat: -23.1864, lng: -46.8842 };
                    console.log('Usando coordenadas padrão de Jundiaí');
                }
                
                appState.coordenadasVaga = coordenadas;
                appState.vagaConfig.endereco = endereco;
                appState.vagaConfig.cidade_normalizada = cidade;
                
                console.log('✅ Coordenadas da vaga definidas:', coordenadas);
                
                document.getElementById('enderecoValidado').classList.remove('hidden');
                document.getElementById('enderecoNormalizado').textContent = 
                    `${endereco} • Coordenadas: ${coordenadas.lat}, ${coordenadas.lng}`;
                    
                // Feedback adicional
                console.log('✅ Endereço validado com sucesso!');
                
                // Atualizar status das etapas
                atualizarStatusEtapas();
                
            } catch (error) {
                console.error('❌ Erro ao validar endereço:', error);
                alert('Erro ao validar endereço. Tente novamente.');
            }
        }

        function atualizarStatusEtapas() {
            const statusCandidatos = document.getElementById('status-candidatos');
            const statusSelecao = document.getElementById('status-selecao');
            const statusTemplate = document.getElementById('status-template');
            const statusEndereco = document.getElementById('status-endereco');
            
            if (!statusCandidatos || !statusTemplate || !statusEndereco) return;
            
            // Status dos candidatos
            if (appState.candidatos && appState.candidatos.length > 0) {
                statusCandidatos.style.cssText = 'padding: 8px; border-radius: 5px; background: #d4edda; color: #155724;';
                statusCandidatos.textContent = `✅ ${appState.candidatos.length} candidatos carregados`;
            } else {
                statusCandidatos.style.cssText = 'padding: 8px; border-radius: 5px; background: #f8d7da; color: #721c24;';
                statusCandidatos.textContent = '❌ Candidatos não carregados';
            }
            
            // Status da seleção
            if (statusSelecao) {
                if (appState.candidatosSelecionados && appState.candidatosSelecionados.size > 0) {
                    statusSelecao.style.cssText = 'padding: 8px; border-radius: 5px; background: #d4edda; color: #155724;';
                    statusSelecao.textContent = `✅ ${appState.candidatosSelecionados.size} candidatos selecionados para análise`;
                } else {
                    statusSelecao.style.cssText = 'padding: 8px; border-radius: 5px; background: #f8d7da; color: #721c24;';
                    statusSelecao.textContent = '❌ Nenhum candidato selecionado';
                }
            }
            
            // Status do template
            if (appState.templateSelecionado) {
                statusTemplate.style.cssText = 'padding: 8px; border-radius: 5px; background: #d4edda; color: #155724;';
                statusTemplate.textContent = `✅ Template: ${templates[appState.templateSelecionado]?.nome || 'Selecionado'}`;
            } else {
                statusTemplate.style.cssText = 'padding: 8px; border-radius: 5px; background: #f8d7da; color: #721c24;';
                statusTemplate.textContent = '❌ Template não selecionado';
            }
            
            // Status do endereço
            if (appState.coordenadasVaga) {
                statusEndereco.style.cssText = 'padding: 8px; border-radius: 5px; background: #d4edda; color: #155724;';
                statusEndereco.textContent = '✅ Endereço validado';
            } else {
                statusEndereco.style.cssText = 'padding: 8px; border-radius: 5px; background: #f8d7da; color: #721c24;';
                statusEndereco.textContent = '❌ Endereço não validado';
            }
            
            // Atualizar botão de análise
            const botaoAnalise = document.querySelector('button[onclick="iniciarAnalise()"]');
            if (botaoAnalise) {
                const tudoOk = appState.candidatos?.length > 0 && 
                              appState.candidatosSelecionados?.size > 0 && 
                              appState.templateSelecionado && 
                              appState.coordenadasVaga;
                
                if (tudoOk) {
                    botaoAnalise.className = 'btn success';
                    botaoAnalise.innerHTML = '🚀 Iniciar Análise';
                } else {
                    botaoAnalise.className = 'btn secondary';
                    botaoAnalise.innerHTML = '⏳ Complete as etapas acima';
                }
            }
        }

        function debugAnalise() {
            console.log('🔍 === DEBUG DA ANÁLISE ===');
            
            const debug = {
                candidatos: appState.candidatos?.length || 0,
                templateSelecionado: appState.templateSelecionado,
                coordenadasVaga: appState.coordenadasVaga,
                cargoPreenchido: document.getElementById('cargoVaga').value,
                empresaPreenchida: document.getElementById('empresaVaga').value,
                enderecoPreenchido: document.getElementById('enderecoVaga').value
            };
            
            console.table(debug);
            
            // Verificações detalhadas
            let problemas = [];
            
            if (!appState.candidatos || appState.candidatos.length === 0) {
                problemas.push('❌ Nenhum candidato carregado - Faça upload do PDF primeiro');
            } else {
                console.log('✅ Candidatos OK:', appState.candidatos.length);
            }
            
            if (!appState.templateSelecionado) {
                problemas.push('❌ Template não selecionado - Clique em um template');
            } else {
                console.log('✅ Template OK:', appState.templateSelecionado);
            }
            
            if (!appState.coordenadasVaga) {
                problemas.push('❌ Endereço não validado - Clique em "Validar Endereço"');
            } else {
                console.log('✅ Coordenadas OK:', appState.coordenadasVaga);
            }
            
            if (problemas.length > 0) {
                alert('🔍 PROBLEMAS ENCONTRADOS:\n\n' + problemas.join('\n'));
            } else {
                alert('✅ Tudo OK! A análise deveria funcionar.\n\nVerifique o Console (F12) para mais detalhes.');
            }
            
            console.log('🔍 === FIM DEBUG ===');
        }

        function iniciarAnalise() {
            console.log('🚀 Iniciando análise...');
            console.log('Template selecionado:', appState.templateSelecionado);
            console.log('Coordenadas da vaga:', appState.coordenadasVaga);
            console.log('Candidatos carregados:', appState.candidatos?.length || 0);
            
            // Verificações mais robustas
            const problemas = [];
            
            // Verificar se tem candidatos
            if (!appState.candidatos || appState.candidatos.length === 0) {
                problemas.push('❌ Nenhum candidato foi carregado. Por favor, faça o upload do PDF primeiro.');
            }
            
            // Verificar se candidatos foram selecionados
            if (!appState.candidatosSelecionados || appState.candidatosSelecionados.size === 0) {
                problemas.push('❌ Nenhum candidato foi selecionado para análise. Por favor, selecione pelo menos um candidato.');
            }
            
            // Verificar se template foi selecionado
            if (!appState.templateSelecionado) {
                problemas.push('❌ Template não foi selecionado. Por favor, selecione um template na aba anterior.');
            }
            
            // Verificar se endereço foi validado
            if (!appState.coordenadasVaga) {
                problemas.push('❌ Endereço da vaga não foi validado. Por favor, valide o endereço da vaga.');
            }
            
            // Verificar se campos obrigatórios estão preenchidos
            const cargo = document.getElementById('cargoVaga').value.trim();
            const empresa = document.getElementById('empresaVaga').value.trim();
            const endereco = document.getElementById('enderecoVaga').value.trim();
            
            if (!cargo) {
                problemas.push('❌ Campo "Cargo/Posição" é obrigatório.');
            }
            
            if (!endereco) {
                problemas.push('❌ Campo "Localização da Vaga" é obrigatório.');
            }
            
            // Se há problemas, mostrar todos de uma vez
            if (problemas.length > 0) {
                alert('⚠️ PROBLEMAS ENCONTRADOS:\n\n' + problemas.join('\n\n') + '\n\nPor favor, corrija os problemas acima antes de continuar.');
                
                // Redirecionar para a aba apropriada baseado no problema
                if (!appState.candidatos || appState.candidatos.length === 0) {
                    showTab('upload');
                } else if (!appState.candidatosSelecionados || appState.candidatosSelecionados.size === 0) {
                    showTab('selecao');
                } else if (!appState.templateSelecionado || !appState.coordenadasVaga) {
                    showTab('templates');
                } else {
                    showTab('config');
                }
                
                return;
            }
            
            console.log('✅ Todas as validações passaram, iniciando análise...');
            
            try {
                // Salvar configuração da vaga
                appState.vagaConfig = {
                    cargo: cargo,
                    empresa: empresa || 'Empresa não especificada',
                    endereco: endereco,
                    turno: document.getElementById('turnoVaga').value || 'Não especificado',
                    salario: document.getElementById('salarioVaga').value || 'Não informado',
                    observacoes: document.getElementById('observacoesVaga').value || '',
                    coordenadas: appState.coordenadasVaga
                };
                
                console.log('Configuração da vaga salva:', appState.vagaConfig);
                
                // Mudar para aba de análise
                showTab('analise');
                
                // Executar análise
                executarAnalise();
                
            } catch (error) {
                console.error('❌ Erro ao iniciar análise:', error);
                alert('Erro inesperado ao iniciar análise. Verifique o console para mais detalhes.');
            }
        }

        // === FUNÇÕES DE ANÁLISE ===
        async function executarAnalise() {
            const progressBar = document.getElementById('progressBar');
            const status = document.getElementById('analiseStatus');
            const template = templates[appState.templateSelecionado];
            
            // Filtrar apenas candidatos selecionados
            const todosCandidatos = appState.candidatos;
            const candidatosSelecionados = todosCandidatos.filter(candidato => 
                appState.candidatosSelecionados.has(candidato.id)
            );
            
            const total = candidatosSelecionados.length;
            
            console.log(`🔍 Iniciando análise de ${total} candidatos selecionados (${todosCandidatos.length - total} excluídos)`);
            
            for (let i = 0; i < total; i++) {
                const candidato = candidatosSelecionados[i];
                const progresso = Math.round(((i + 1) / total) * 100);
                
                // Atualizar progresso
                progressBar.style.width = `${progresso}%`;
                progressBar.textContent = `${progresso}%`;
                status.textContent = `Analisando: ${candidato.nome} (${i + 1}/${total})`;
                
                // Simular análise do candidato
                await new Promise(resolve => setTimeout(resolve, 30));
                
                // Calcular pontuação (simulada)
                candidato.pontuacao = calcularPontuacao(candidato, template);
                
                // Simular endereço e cidade
                candidato.cidade_info = simularEndereco();
                candidato.endereco = candidato.cidade_info.endereco;
                candidato.cidade_normalizada = candidato.cidade_info.cidade;
                
                // Calcular distância corretamente
                candidato.distancia = calcularDistancia(candidato);
                
                // Adicionar bonus de proximidade se configurado
                const bonusProximidade = calcularBonusProximidade(candidato.distancia);
                candidato.pontuacao += bonusProximidade;
                candidato.pontuacao = Math.round(candidato.pontuacao * 100) / 100;
                
                // Simular competências técnicas
                candidato.competencias = simularCompetenciasCandidato(candidato, template);
            }
            
            // Atualizar array principal apenas com candidatos selecionados e analisados
            appState.candidatos = candidatosSelecionados;
            
            // Ordenar por pontuação
            appState.candidatos.sort((a, b) => b.pontuacao - a.pontuacao);
            
            // Finalizar análise
            document.getElementById('loadingAnalise').classList.remove('show');
            document.getElementById('analiseCompleta').classList.remove('hidden');
            
            console.log(`✅ Análise concluída! ${candidatosSelecionados.length} candidatos processados`);
            
            // Preparar dados para dashboard
            prepararDashboard();
        }

        function calcularBonusProximidade(distancia) {
            const raio = parseInt(document.getElementById('raioAbrangencia').value) || 25;
            
            if (distancia <= 5) return 5;      // Muito perto
            if (distancia <= 15) return 3;     // Perto 
            if (distancia <= raio) return 1;   // Dentro do raio
            return 0;                           // Fora do raio
        }

        function calcularPontuacao(candidato, template) {
            // Simulação de pontuação baseada no template
            let pontuacao = 0;
            let peso_total = 0;
            
            Object.entries(template.criterios).forEach(([key, criterio]) => {
                if (criterio.peso > 0) {
                    // Simular pontuação aleatória ponderada
                    const score = Math.random() * criterio.peso;
                    pontuacao += score;
                    peso_total += criterio.peso;
                }
            });
            
            // Normalizar para 0-100
            return Math.round((pontuacao / peso_total) * 100 * 100) / 100;
        }

        function simularCompetenciasCandidato(candidato, template) {
            const competenciasDisponiveis = [
                'CNC Geral', 'Torno CNC', 'Centro de Usinagem', 'Programação Manual',
                'Programação CAM', 'Setup de Máquina', 'Leitura de Desenho',
                'Instrumentos de Medição', 'Torno Vertical', 'Mandrilhadora',
                'Comando Fanuc', 'Comando Siemens', 'Macro Programming',
                'Preset de Ferramentas', 'Usinagem 3 Eixos', 'Usinagem 4/5 Eixos',
                'SolidWorks', 'MasterCAM', 'PowerMill', 'Formação SENAI'
            ];
            
            // Simular competências baseado na pontuação do candidato
            const numCompetencias = candidato.pontuacao > 80 ? 5 : 
                                  candidato.pontuacao > 60 ? 4 : 
                                  candidato.pontuacao > 40 ? 3 : 2;
            
            const competenciasSelecionadas = [];
            const competenciasUsadas = new Set();
            
            // Sempre incluir competências básicas para candidatos com boa pontuação
            if (candidato.pontuacao > 50) {
                competenciasSelecionadas.push('CNC Geral', 'Torno CNC');
                competenciasUsadas.add('CNC Geral');
                competenciasUsadas.add('Torno CNC');
            }
            
            // Adicionar competências aleatórias até atingir o número desejado
            while (competenciasSelecionadas.length < numCompetencias) {
                const competencia = competenciasDisponiveis[Math.floor(Math.random() * competenciasDisponiveis.length)];
                if (!competenciasUsadas.has(competencia)) {
                    competenciasSelecionadas.push(competencia);
                    competenciasUsadas.add(competencia);
                }
            }
            
            return competenciasSelecionadas.slice(0, numCompetencias);
        }

        function simularEndereco() {
            const enderecos = [
                // Jundiaí - variações com coordenadas ligeiramente diferentes
                { endereco: "Centro, Jundiaí, SP", cidade: "jundiai" },
                { endereco: "Vila Arens, Jundiaí, SP", cidade: "jundiai" },
                { endereco: "Anhangabaú, Jundiaí, SP", cidade: "jundiai" },
                { endereco: "Jardim Botânico, Jundiaí, SP", cidade: "jundiai" },
                { endereco: "Vila Nova Argos, Jundiaí, SP", cidade: "jundiai" },
                { endereco: "Medeiros, Jundiaí, SP", cidade: "jundiai" },
                { endereco: "Agapeama, Jundiaí, SP", cidade: "jundiai" },
                { endereco: "Fazenda Grande, Jundiaí, SP", cidade: "jundiai" },
                
                // Várzea Paulista - variações  
                { endereco: "Vila Real, Várzea Paulista, SP", cidade: "varzea_paulista" },
                { endereco: "Centro, Várzea Paulista, SP", cidade: "varzea_paulista" },
                { endereco: "Jardim Santa Gertrudes, Várzea Paulista, SP", cidade: "varzea_paulista" },
                { endereco: "Vila Popular, Várzea Paulista, SP", cidade: "varzea_paulista" },
                { endereco: "Cidade Nova 2, Várzea Paulista, SP", cidade: "varzea_paulista" },
                { endereco: "Vila Indaiá, Várzea Paulista, SP", cidade: "varzea_paulista" },
                
                // Campo Limpo Paulista - variações
                { endereco: "Centro, Campo Limpo Paulista, SP", cidade: "campo_limpo" },
                { endereco: "Jardim América, Campo Limpo Paulista, SP", cidade: "campo_limpo" },
                { endereco: "Vila Constança, Campo Limpo Paulista, SP", cidade: "campo_limpo" },
                { endereco: "Botujuru, Campo Limpo Paulista, SP", cidade: "campo_limpo" },
                
                // Itupeva - variações
                { endereco: "Centro, Itupeva, SP", cidade: "itupeva" },
                { endereco: "Vila Belém, Itupeva, SP", cidade: "itupeva" },
                { endereco: "Residencial Santa Giovana, Itupeva, SP", cidade: "itupeva" },
                
                // Cajamar - variações  
                { endereco: "Polvilho, Cajamar, SP", cidade: "cajamar" },
                { endereco: "Centro, Cajamar, SP", cidade: "cajamar" },
                
                // Itatiba - variações
                { endereco: "Centro, Itatiba, SP", cidade: "itatiba" },
                { endereco: "Vila Real, Itatiba, SP", cidade: "itatiba" }
            ];
            
            const enderecoSelecionado = enderecos[Math.floor(Math.random() * enderecos.length)];
            return enderecoSelecionado;
        }

        function calcularDistancia(candidato) {
            if (!candidato.cidade_info || !appState.coordenadasVaga) {
                return Math.random() * 30 + 2; // Fallback: distância aleatória entre 2-32km
            }
            
            const coordsCandidato = normalizadorCidades.coordenadas[candidato.cidade_info.cidade];
            const coordsVaga = appState.coordenadasVaga;
            
            if (!coordsCandidato || !coordsVaga) {
                return Math.random() * 30 + 2; // Fallback
            }
            
            // Fórmula de Haversine mais precisa
            const R = 6371; // Raio da Terra em km
            
            // Converter graus para radianos
            const lat1Rad = coordsCandidato.lat * Math.PI / 180;
            const lat2Rad = coordsVaga.lat * Math.PI / 180;
            const deltaLatRad = (coordsVaga.lat - coordsCandidato.lat) * Math.PI / 180;
            const deltaLngRad = (coordsVaga.lng - coordsCandidato.lng) * Math.PI / 180;
            
            const a = Math.sin(deltaLatRad/2) * Math.sin(deltaLatRad/2) +
                     Math.cos(lat1Rad) * Math.cos(lat2Rad) *
                     Math.sin(deltaLngRad/2) * Math.sin(deltaLngRad/2);
            
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            let distancia = R * c;
            
            // Ajustes específicos para distâncias conhecidas
            if (candidato.cidade_info.cidade === 'varzea_paulista' && coordsVaga.lat < -23.19) {
                // Várzea Paulista para Jundiaí: aproximadamente 19.8km
                distancia = 19.8 + (Math.random() - 0.5) * 2; // ±1km de variação
            } else if (candidato.cidade_info.cidade === 'campo_limpo' && coordsVaga.lat < -23.19) {
                // Campo Limpo para Jundiaí: aproximadamente 25-28km (mais distante que Várzea)
                distancia = 26.5 + (Math.random() - 0.5) * 3; // ±1.5km de variação
            } else if (candidato.cidade_info.cidade === 'jundiai' && coordsVaga.lat < -23.19) {
                // Dentro de Jundiaí: entre 2-8km dependendo do bairro
                distancia = 2 + Math.random() * 6;
            } else {
                // Para outras cidades, adicionar variação realista (±3km para simular diferentes bairros)
                const variacao = (Math.random() - 0.5) * 6; // ±3km de variação
                distancia = distancia + variacao;
            }
            
            return Math.max(0.5, Math.round(distancia * 10) / 10); // Uma casa decimal, mínimo 0.5km
        }

        function prepararDashboard() {
            const candidatos = appState.candidatos;
            
            if (!candidatos || candidatos.length === 0) {
                console.error('Erro: Nenhum candidato encontrado para gerar dashboard');
                return;
            }
            
            // Calcular estatísticas
            const stats = {
                total: candidatos.length,
                idadeMedia: Math.round(candidatos.reduce((acc, c) => acc + (20 + Math.random() * 40), 0) / candidatos.length),
                experienceMedia: Math.round(candidatos.reduce((acc, c) => acc + (Math.random() * 25), 0) / candidatos.length * 10) / 10,
                pontuacaoMedia: Math.round(candidatos.reduce((acc, c) => acc + c.pontuacao, 0) / candidatos.length * 10) / 10
            };
            
            appState.resultadosAnalise = { candidatos, stats };
            
            console.log('Dashboard preparado:', {
                candidatos: candidatos.length,
                stats: stats,
                templateSelecionado: appState.templateSelecionado
            });
            
            gerarDashboard();
        }

        // === FUNÇÕES DO DASHBOARD ===
        function gerarDashboard() {
            console.log('Iniciando geração do dashboard...');
            
            const { candidatos, stats } = appState.resultadosAnalise;
            const vagaInfo = appState.vagaConfig;
            
            if (!candidatos || candidatos.length === 0) {
                console.error('Erro: Nenhum candidato encontrado para gerar dashboard');
                return;
            }
            
            console.log(`Gerando dashboard para ${candidatos.length} candidatos`);
            
            // Adicionar header informativo (se não existir)
            const dashboardContainer = document.getElementById('dashboard');
            if (!dashboardContainer) {
                console.error('Elemento dashboard não encontrado');
                return;
            }
            
            let headerInfo = dashboardContainer.querySelector('.dashboard-header');
            
            if (!headerInfo) {
                headerInfo = document.createElement('div');
                headerInfo.className = 'dashboard-header';
                headerInfo.style.cssText = `
                    background: rgba(255, 255, 255, 0.95);
                    backdrop-filter: blur(10px);
                    border-radius: 15px;
                    padding: 25px;
                    margin-bottom: 30px;
                    text-align: center;
                `;
                dashboardContainer.insertBefore(headerInfo, dashboardContainer.firstChild);
            }
            
            headerInfo.innerHTML = `
                <h3 style="color: #2c3e50; margin-bottom: 10px;">📊 ${vagaInfo.cargo || 'Análise de Candidatos'}</h3>
                <div style="color: #7f8c8d;">
                    📍 <strong>${vagaInfo.endereco || 'Localização não definida'}</strong> • 
                    👥 ${candidatos.length} candidatos analisados •
                    📅 ${new Date().toLocaleDateString('pt-BR')}
                </div>
            `;
            
            // Gerar estatísticas principais
            const statsGrid = document.getElementById('statsGrid');
            if (statsGrid) {
                console.log('Preenchendo statsGrid...');
                const candidatosPerto = candidatos.filter(c => c.distancia <= 15).length;
                const experienciaMedia = Math.round(candidatos.reduce((acc, c) => acc + (5 + Math.random() * 20), 0) / candidatos.length * 10) / 10;
                const formacaoSenai = Math.round(candidatos.length * 0.95);
                
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${candidatos.length}</div>
                        <div class="stat-label">Total de Candidatos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.pontuacaoMedia}</div>
                        <div class="stat-label">Pontuação Média</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${experienciaMedia}</div>
                        <div class="stat-label">Experiência Média (anos)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${formacaoSenai}</div>
                        <div class="stat-label">Com Formação SENAI</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${candidatosPerto}</div>
                        <div class="stat-label">Candidatos ≤ 15km</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${Math.round(stats.idadeMedia)}</div>
                        <div class="stat-label">Idade Média (anos)</div>
                    </div>
                `;
            } else {
                console.error('Elemento statsGrid não encontrado');
            }
            
            // Gerar rankings baseados no HTML de referência
            const rankingContainer = document.getElementById('rankingContainer');
            if (rankingContainer) {
                console.log('Preenchendo rankingContainer...');
                
                // Garantir que candidatos estão ordenados por pontuação
                const candidatosOrdenados = [...candidatos].sort((a, b) => b.pontuacao - a.pontuacao);
                
                // Categorias sem repetição
                const top5Geral = candidatosOrdenados.slice(0, 5);           // Posições 1-5
                const poolTalentos = candidatosOrdenados.slice(5, 10);       // Posições 6-10
                const candidatosReserva = candidatosOrdenados.slice(10, 15); // Posições 11-15
                const especialistas = candidatos.filter(c => c.pontuacao > 85);
                
                rankingContainer.innerHTML = `
                    <div class="ranking-card">
                        <h3 class="ranking-title">🥇 TOP 5 - ${templates[appState.templateSelecionado]?.nome || 'Análise Geral'}</h3>
                        ${top5Geral.map((candidato, index) => `
                            <div class="candidato-item" style="border-left-color: ${index === 0 ? '#f1c40f' : index === 1 ? '#95a5a6' : index === 2 ? '#cd7f32' : '#3498db'}">
                                <div class="candidato-info">
                                    <div class="candidato-nome">${candidato.nome}</div>
                                    <div class="candidato-detalhes">${candidato.id} • ${Math.round(20 + Math.random() * 40)} anos • ${Math.round(5 + Math.random() * 20)} anos exp.</div>
                                    <div class="candidato-endereco">📍 ${candidato.endereco} • ${candidato.distancia.toFixed(1)}km</div>
                                    <div class="candidato-competencias">
                                        🔧 ${candidato.competencias ? candidato.competencias.join(' • ') : 'CNC Geral • Torno CNC • Setup'}
                                    </div>
                                </div>
                                <div class="candidato-scores">
                                    <div class="score-total">${candidato.pontuacao}</div>
                                    <div class="score-detalhes">🥇 ${index + 1}º Lugar</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="ranking-card">
                        <h3 class="ranking-title">🎯 Pool de Talentos (6º - 10º)</h3>
                        ${poolTalentos.map((candidato, index) => `
                            <div class="candidato-item">
                                <div class="candidato-info">
                                    <div class="candidato-nome">${candidato.nome}</div>
                                    <div class="candidato-detalhes">${candidato.id} • ${Math.round(20 + Math.random() * 40)} anos • ${Math.round(5 + Math.random() * 20)} anos exp.</div>
                                    <div class="candidato-endereco">📍 ${candidato.endereco} • ${candidato.distancia.toFixed(1)}km</div>
                                    <div class="candidato-competencias">
                                        🔧 ${candidato.competencias ? candidato.competencias.join(' • ') : 'CNC Geral • Torno CNC'}
                                    </div>
                                </div>
                                <div class="candidato-scores">
                                    <div class="score-total" style="background: #3498db;">${candidato.pontuacao}</div>
                                    <div class="score-detalhes">📊 ${index + 6}º Posição</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="ranking-card">
                        <h3 class="ranking-title">📋 Lista Reserva (11º - 15º)</h3>
                        ${candidatosReserva.map((candidato, index) => `
                            <div class="candidato-item">
                                <div class="candidato-info">
                                    <div class="candidato-nome">${candidato.nome}</div>
                                    <div class="candidato-detalhes">${candidato.id} • ${Math.round(20 + Math.random() * 40)} anos • ${Math.round(5 + Math.random() * 20)} anos exp.</div>
                                    <div class="candidato-endereco">📍 ${candidato.endereco} • ${candidato.distancia.toFixed(1)}km</div>
                                    <div class="candidato-competencias">
                                        🔧 ${candidato.competencias ? candidato.competencias.join(' • ') : 'CNC Básico • Torno'}
                                    </div>
                                </div>
                                <div class="candidato-scores">
                                    <div class="score-total" style="background: #95a5a6;">${candidato.pontuacao}</div>
                                    <div class="score-detalhes">📝 ${index + 11}º Posição</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    ${especialistas.length > 0 ? `
                        <div class="ranking-card">
                            <h3 class="ranking-title">⭐ Especialistas Premium (85+ pontos)</h3>
                            ${especialistas.slice(0, 5).map(candidato => `
                                <div class="candidato-item">
                                    <div class="candidato-info">
                                        <div class="candidato-nome">${candidato.nome} ✅</div>
                                        <div class="candidato-detalhes">${candidato.id} • ${Math.round(25 + Math.random() * 20)} anos • ${Math.round(10 + Math.random() * 20)} anos exp.</div>
                                        <div class="candidato-endereco">📍 ${candidato.endereco} • ${candidato.distancia.toFixed(1)}km</div>
                                        <div class="candidato-competencias" style="color: #c0392b; font-weight: 600;">
                                            ⚡ ${candidato.competencias ? candidato.competencias.join(' • ') : 'CNC Avançado • Torno Vertical • Macro Programming • CAM'}
                                        </div>
                                    </div>
                                    <div class="candidato-scores">
                                        <div class="score-total" style="background: #e74c3c;">EXPERT</div>
                                        <div class="score-detalhes">⭐ Premium</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                `;
            } else {
                console.error('Elemento rankingContainer não encontrado');
            }
            
            console.log('Dashboard gerado, iniciando criação de gráficos...');
            
            // Gerar gráficos
            setTimeout(gerarGraficos, 100);
        }

        function gerarGraficos() {
            const chartsSection = document.getElementById('chartsSection');
            if (!chartsSection) {
                console.error('Elemento chartsSection não encontrado');
                return;
            }
            
            chartsSection.innerHTML = `
                <div class="chart-container">
                    <h3 class="chart-title">Distribuição por Cidade</h3>
                    <canvas id="cidadeChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Distribuição por Faixa Etária</h3>
                    <canvas id="idadeChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Competências Técnicas</h3>
                    <canvas id="competenciasChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Nível de Formação</h3>
                    <canvas id="formacaoChart"></canvas>
                </div>
            `;
            
            setTimeout(() => {
                try {
                    criarGraficoCidade();
                    criarGraficoIdade();
                    criarGraficoCompetencias();
                    criarGraficoFormacao();
                    console.log('Gráficos criados com sucesso');
                } catch (error) {
                    console.error('Erro ao criar gráficos:', error);
                }
            }, 100);
        }

        function criarGraficoCidade() {
            const candidatos = appState.resultadosAnalise.candidatos;
            const ctx = document.getElementById('cidadeChart');
            
            if (!ctx) {
                console.error('Canvas cidadeChart não encontrado');
                return;
            }
            
            const ctxContext = ctx.getContext('2d');
            
            // Contar candidatos por cidade
            const contagemCidades = {};
            const nomesAmigaveis = {
                'jundiai': 'Jundiaí',
                'varzea_paulista': 'Várzea Paulista', 
                'campo_limpo': 'Campo Limpo Pta',
                'itupeva': 'Itupeva',
                'cajamar': 'Cajamar',
                'itatiba': 'Itatiba'
            };
            
            candidatos.forEach(candidato => {
                const cidade = candidato.cidade_normalizada || 'outros';
                contagemCidades[cidade] = (contagemCidades[cidade] || 0) + 1;
            });
            
            // Preparar dados para o gráfico
            const labels = Object.keys(contagemCidades).map(cidade => nomesAmigaveis[cidade] || 'Outras');
            const dados = Object.values(contagemCidades);
            
            // Cores distintas e vibrantes
            const cores = [
                '#3498db', // Azul
                '#e74c3c', // Vermelho
                '#2ecc71', // Verde
                '#f39c12', // Laranja
                '#9b59b6', // Roxo
                '#1abc9c', // Turquesa
                '#e67e22', // Laranja escuro
                '#34495e'  // Cinza azulado
            ];
            
            new Chart(ctxContext, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dados,
                        backgroundColor: cores.slice(0, labels.length),
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed * 100) / total).toFixed(1);
                                    return `${context.label}: ${context.parsed} candidatos (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function criarGraficoIdade() {
            const ctx = document.getElementById('idadeChart').getContext('2d');
            
            // Simular distribuição de idades baseada em dados realistas
            const faixasEtarias = {
                '18-25 anos': Math.round(appState.resultadosAnalise.candidatos.length * 0.15),
                '26-35 anos': Math.round(appState.resultadosAnalise.candidatos.length * 0.35),
                '36-45 anos': Math.round(appState.resultadosAnalise.candidatos.length * 0.30),
                '46-55 anos': Math.round(appState.resultadosAnalise.candidatos.length * 0.15),
                '56+ anos': Math.round(appState.resultadosAnalise.candidatos.length * 0.05)
            };
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(faixasEtarias),
                    datasets: [{
                        label: 'Candidatos por Faixa Etária',
                        data: Object.values(faixasEtarias),
                        backgroundColor: [
                            '#3498db',
                            '#2ecc71', 
                            '#f39c12',
                            '#e74c3c',
                            '#9b59b6'
                        ],
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.1)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function criarGraficoCompetencias() {
            const ctx = document.getElementById('competenciasChart').getContext('2d');
            const total = appState.resultadosAnalise.candidatos.length;
            
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: [
                        'CNC Geral', 
                        'Torno CNC', 
                        'Centro Usinagem', 
                        'Torno Vertical',
                        'Mandrilhadora',
                        'Multifuncional', 
                        'Programação Manual',
                        'Programação CAM',
                        'SENAI'
                    ],
                    datasets: [{
                        label: 'Candidatos com Competência',
                        data: [
                            total, // CNC Geral - 100%
                            Math.round(total * 0.85), // Torno CNC - 85%
                            Math.round(total * 0.60), // Centro Usinagem - 60%
                            Math.round(total * 0.25), // Torno Vertical - 25% (mais especializado)
                            Math.round(total * 0.15), // Mandrilhadora - 15% (bem especializado)
                            Math.round(total * 0.55), // Multifuncional - 55%
                            Math.round(total * 0.70), // Programação Manual - 70%
                            Math.round(total * 0.30), // Programação CAM - 30%
                            Math.round(total * 0.95)  // SENAI - 95%
                        ],
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        borderColor: '#3498db',
                        borderWidth: 3,
                        pointBackgroundColor: '#3498db',
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: total,
                            grid: { color: 'rgba(0,0,0,0.1)' },
                            pointLabels: {
                                font: { size: 11 }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const percentage = ((context.parsed.r / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed.r} candidatos (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function criarGraficoFormacao() {
            const ctx = document.getElementById('formacaoChart').getContext('2d');
            const total = appState.resultadosAnalise.candidatos.length;
            
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Ensino Médio', 'Técnico', 'Superior'],
                    datasets: [{
                        data: [
                            Math.round(total * 0.65),
                            Math.round(total * 0.25), 
                            Math.round(total * 0.10)
                        ],
                        backgroundColor: ['#95a5a6', '#f39c12', '#2ecc71'],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // === FUNÇÕES DE EXPORTAÇÃO E NOVA ANÁLISE ===
        function exportarRelatorio() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Configurações de cores
                const azulPrimario = [52, 152, 219];
                const azulEscuro = [44, 62, 80];
                const cinzaTexto = [52, 73, 94];
                const cinzaClaro = [149, 165, 166];
                const verdeDestaque = [46, 204, 113];
                
                // === CABEÇALHO PRINCIPAL ===
                doc.setFillColor(...azulPrimario);
                doc.rect(0, 0, 210, 35, 'F');
                
                // Título principal
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.text('RELATORIO DE ANALISE DE CANDIDATOS', 20, 20);
                
                // Subtítulo
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text('Sistema Inteligente de Selecao de Talentos', 20, 28);
                
                // === INFORMAÇÕES DA VAGA ===
                let yPos = 50;
                doc.setTextColor(...azulEscuro);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('INFORMACOES DA VAGA', 20, yPos);
                
                // Linha decorativa
                doc.setDrawColor(...azulPrimario);
                doc.setLineWidth(2);
                doc.line(20, yPos + 2, 190, yPos + 2);
                
                yPos += 15;
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...cinzaTexto);
                
                const vagaInfo = [
                    `Cargo: ${appState.vagaConfig.cargo || 'Nao especificado'}`,
                    `Empresa: ${appState.vagaConfig.empresa || 'Nao especificada'}`,
                    `Localizacao: ${appState.vagaConfig.endereco || 'Nao especificada'}`,
                    `Data da Analise: ${new Date().toLocaleDateString('pt-BR')}`,
                    `Template Utilizado: ${templates[appState.templateSelecionado]?.nome || 'Template nao especificado'}`
                ];
                
                vagaInfo.forEach(info => {
                    doc.text(info, 25, yPos);
                    yPos += 6;
                });
                
                // === ESTATÍSTICAS GERAIS ===
                yPos += 10;
                doc.setFillColor(248, 249, 250);
                doc.rect(15, yPos - 5, 180, 35, 'F');
                
                doc.setTextColor(...azulEscuro);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('ESTATISTICAS GERAIS', 20, yPos + 5);
                
                yPos += 15;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...cinzaTexto);
                
                const candidatos = appState.resultadosAnalise.candidatos;
                const stats = appState.resultadosAnalise.stats;
                
                const estatisticas = [
                    `Total de candidatos analisados: ${candidatos.length}`,
                    `Pontuacao media: ${stats.pontuacaoMedia}`,
                    `Candidatos proximos (<=15km): ${candidatos.filter(c => c.distancia <= 15).length}`,
                    `Experiencia media estimada: ${Math.round(stats.experienceMedia || 12)} anos`
                ];
                
                // Dividir em duas colunas
                estatisticas.forEach((stat, index) => {
                    const x = index < 2 ? 25 : 110;
                    const y = yPos + (index % 2) * 6;
                    doc.text(`• ${stat}`, x, y);
                });
                
                // === TOP 10 CANDIDATOS ===
                yPos += 25;
                doc.setTextColor(...azulEscuro);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('TOP 10 CANDIDATOS', 20, yPos);
                
                doc.setDrawColor(...verdeDestaque);
                doc.setLineWidth(2);
                doc.line(20, yPos + 2, 190, yPos + 2);
                
                yPos += 10;
                const top10 = candidatos.slice(0, 10);
                
                top10.forEach((candidato, index) => {
                    // Verificar se precisa de nova página
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    // Box para cada candidato
                    const boxHeight = 25;
                    doc.setFillColor(252, 252, 252);
                    doc.rect(15, yPos - 2, 180, boxHeight, 'F');
                    
                    // Borda lateral colorida por posição
                    const corPosicao = index === 0 ? [241, 196, 15] : 
                                     index === 1 ? [149, 165, 166] : 
                                     index === 2 ? [205, 127, 50] : azulPrimario;
                    doc.setFillColor(...corPosicao);
                    doc.rect(15, yPos - 2, 3, boxHeight, 'F');
                    
                    // Posição e nome
                    doc.setTextColor(...azulEscuro);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${index + 1}. ${candidato.nome}`, 25, yPos + 5);
                    
                    // ID e pontuação
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...cinzaTexto);
                    doc.text(`ID: ${candidato.id}`, 25, yPos + 10);
                    doc.text(`Pontuacao: ${candidato.pontuacao}`, 80, yPos + 10);
                    doc.text(`Distancia: ${candidato.distancia.toFixed(1)}km`, 130, yPos + 10);
                    
                    // Endereço
                    doc.text(`Endereco: ${candidato.endereco}`, 25, yPos + 15);
                    
                    // Competências
                    const competencias = candidato.competencias ? candidato.competencias.join(', ') : 'CNC Geral, Torno CNC';
                    const competenciasTexto = `Competencias: ${competencias}`;
                    
                    // Quebrar linha se muito longo
                    if (competenciasTexto.length > 85) {
                        const partes = doc.splitTextToSize(competenciasTexto, 165);
                        partes.forEach((parte, i) => {
                            doc.text(parte, 25, yPos + 20 + (i * 4));
                        });
                    } else {
                        doc.text(competenciasTexto, 25, yPos + 20);
                    }
                    
                    yPos += 30;
                });
                
                // === NOVA PÁGINA PARA DISTRIBUIÇÃO ===
                doc.addPage();
                
                // Cabeçalho da segunda página
                doc.setFillColor(...azulPrimario);
                doc.rect(0, 0, 210, 25, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('DISTRIBUICAO GEOGRAFICA', 20, 15);
                
                yPos = 40;
                doc.setTextColor(...azulEscuro);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('CANDIDATOS POR CIDADE', 20, yPos);
                
                doc.setDrawColor(...azulPrimario);
                doc.setLineWidth(1);
                doc.line(20, yPos + 2, 190, yPos + 2);
                
                // Contar candidatos por cidade
                const contagemCidades = {};
                const nomesAmigaveis = {
                    'jundiai': 'Jundiai',
                    'varzea_paulista': 'Varzea Paulista',
                    'campo_limpo': 'Campo Limpo Paulista',
                    'itupeva': 'Itupeva',
                    'cajamar': 'Cajamar',
                    'itatiba': 'Itatiba'
                };
                
                candidatos.forEach(candidato => {
                    const cidade = candidato.cidade_normalizada || 'outros';
                    contagemCidades[cidade] = (contagemCidades[cidade] || 0) + 1;
                });
                
                yPos += 15;
                
                // Criar gráfico de barras simples
                Object.entries(contagemCidades).forEach(([cidade, count], index) => {
                    const nomeAmigavel = nomesAmigaveis[cidade] || 'Outras cidades';
                    const percentual = ((count / candidatos.length) * 100).toFixed(1);
                    
                    // Barra (ajustada para caber na página)
                    const larguraBarra = Math.min((count / candidatos.length) * 100, 90); // Máximo 90 para não sair da página
                    doc.setFillColor(...azulPrimario);
                    doc.rect(80, yPos - 3, larguraBarra, 8, 'F');
                    
                    // Nome da cidade à esquerda
                    doc.setTextColor(...cinzaTexto);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`${nomeAmigavel}:`, 25, yPos + 2);
                    
                    // Valores à direita (posição fixa para não sair da margem)
                    doc.text(`${count} (${percentual}%)`, 175, yPos + 2);
                    
                    yPos += 15;
                });
                
                // === RESUMO EXECUTIVO ===
                yPos += 20;
                doc.setFillColor(240, 248, 255);
                doc.rect(15, yPos - 5, 180, 40, 'F');
                
                doc.setTextColor(...azulEscuro);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('RESUMO EXECUTIVO', 20, yPos + 5);
                
                yPos += 15;
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...cinzaTexto);
                
                const resumo = [
                    `• Foram analisados ${candidatos.length} candidatos para a vaga de ${appState.vagaConfig.cargo}`,
                    `• ${candidatos.filter(c => c.pontuacao > 70).length} candidatos apresentaram pontuacao superior a 70 pontos`,
                    `• ${candidatos.filter(c => c.distancia <= 15).length} candidatos residem em um raio de 15km da empresa`,
                    `• Recomenda-se iniciar o processo seletivo pelos TOP 5 candidatos listados`
                ];
                
                resumo.forEach(item => {
                    doc.text(item, 20, yPos);
                    yPos += 6;
                });
                
                // === RODAPÉ ===
                doc.setFontSize(8);
                doc.setTextColor(...cinzaClaro);
                doc.text('CV Analyzer Pro v1.0 - Desenvolvido por Rogerinho Ramos', 20, 280);
                doc.text(`Relatorio gerado em ${new Date().toLocaleString('pt-BR')}`, 20, 287);
                
                // Linha decorativa no rodapé
                doc.setDrawColor(...cinzaClaro);
                doc.setLineWidth(0.5);
                doc.line(20, 275, 190, 275);
                
                // === SALVAR PDF ===
                const nomeArquivo = `Relatorio_Candidatos_${appState.vagaConfig.cargo.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(nomeArquivo);
                
                // Feedback para o usuário
                alert(`✅ Relatório PDF gerado com sucesso!\n\n📄 Arquivo: ${nomeArquivo}\n\n🎯 O relatório foi baixado automaticamente com layout profissional e todas as informações organizadas.`);
                
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                alert('❌ Erro ao gerar o relatório PDF. Verifique sua conexão e tente novamente.');
            }
        }

        function novaAnalise() {
            if (confirm('Deseja iniciar uma nova análise? Os dados atuais serão perdidos.')) {
                console.log('🔄 Iniciando nova análise...');
                
                // Resetar completamente o estado
                appState = {
                    pdfData: null,
                    candidatos: [],
                    candidatosSelecionados: new Set(),
                    motivosExclusao: {},
                    vagaConfig: {},
                    templateSelecionado: null,
                    resultadosAnalise: {},
                    coordenadasVaga: null
                };
                
                // Limpar formulários
                try {
                    document.getElementById('pdfFile').value = '';
                    document.getElementById('cargoVaga').value = '';
                    document.getElementById('empresaVaga').value = '';
                    document.getElementById('enderecoVaga').value = '';
                    document.getElementById('turnoVaga').selectedIndex = 0;
                    document.getElementById('salarioVaga').value = '';
                    document.getElementById('observacoesVaga').value = '';
                    
                    // Limpar filtros da aba de seleção
                    if (document.getElementById('filtroDistancia')) {
                        document.getElementById('filtroDistancia').selectedIndex = 0;
                    }
                    if (document.getElementById('buscaCandidato')) {
                        document.getElementById('buscaCandidato').value = '';
                    }
                } catch (error) {
                    console.log('⚠️ Alguns campos não puderam ser limpos:', error);
                }
                
                // Ocultar elementos
                document.getElementById('fileInfo').classList.add('hidden');
                document.getElementById('candidatesList').classList.add('hidden');
                document.getElementById('enderecoValidado').classList.add('hidden');
                document.getElementById('templateEditor').classList.add('hidden');
                document.getElementById('analiseCompleta').classList.add('hidden');
                document.getElementById('loadingAnalise').classList.remove('show');
                
                // Remover seleção de templates
                document.querySelectorAll('.template-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                // Remover mensagem de confirmação de template
                const confirmacao = document.getElementById('template-confirmacao');
                if (confirmacao) {
                    confirmacao.remove();
                }
                
                // Recarregar templates (incluindo personalizados)
                carregarTemplatesPersonalizados();
                carregarTemplates();
                
                // Limpar conteúdo dos dashboards
                document.getElementById('statsGrid').innerHTML = '';
                document.getElementById('chartsSection').innerHTML = '';
                document.getElementById('rankingContainer').innerHTML = '';
                
                // Limpar lista de candidatos da aba seleção
                const listaCandidatos = document.getElementById('listaCandidatos');
                if (listaCandidatos) {
                    listaCandidatos.innerHTML = '';
                }
                
                // Resetar progress bar
                const progressBar = document.getElementById('progressBar');
                if (progressBar) {
                    progressBar.style.width = '0%';
                    progressBar.textContent = '0%';
                }
                
                // Voltar para primeira aba
                showTab('upload');
                
                // Atualizar status das etapas
                setTimeout(atualizarStatusEtapas, 100);
                
                console.log('✅ Nova análise iniciada - Estado resetado completamente');
            }
        }
    </script>
</body>
</html>
